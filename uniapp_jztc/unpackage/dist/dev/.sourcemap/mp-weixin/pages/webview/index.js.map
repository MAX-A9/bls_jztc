{"version":3,"file":"index.js","sources":["pages/webview/index.vue","D:/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvd2Vidmlldy9pbmRleC52dWU"],"sourcesContent":["<template>\r\n\t<view class=\"webview-container\">\r\n\t\t<!-- 加载中指示器 -->\r\n\t\t<view class=\"loading\" v-if=\"!webUrl\">\r\n\t\t\t<view class=\"loading-spinner\"></view>\r\n\t\t\t<text class=\"loading-text\">加载中...</text>\r\n\t\t</view>\r\n\t\t\r\n\t\t<!-- Web视图 -->\r\n\t\t<web-view \r\n\t\t\t:src=\"webUrl\" \r\n\t\t\t@message=\"handleMessage\" \r\n\t\t\t@error=\"handleError\"\r\n\t\t></web-view>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\texport default {\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\twebUrl: '',\r\n\t\t\t\toriginalUrl: '',\r\n\t\t\t\tsecurityEnabled: false,\r\n\t\t\t\turlTitle: ''\r\n\t\t\t}\r\n\t\t},\r\n\t\tonLoad(options) {\r\n\t\t\tif (options.url) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tthis.originalUrl = decodeURIComponent(options.url) || '';\r\n\t\t\t\t\t\r\n\t\t\t\t\t// 提取页面标题（如果URL中包含title参数）\r\n\t\t\t\t\tif (options.title) {\r\n\t\t\t\t\t\tthis.urlTitle = decodeURIComponent(options.title);\r\n\t\t\t\t\t\t// 设置导航栏标题\r\n\t\t\t\t\t\tuni.setNavigationBarTitle({\r\n\t\t\t\t\t\t\ttitle: this.urlTitle\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// 使用默认标题\r\n\t\t\t\t\t\tuni.setNavigationBarTitle({\r\n\t\t\t\t\t\t\ttitle: '网页浏览'\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t// 启用WebView安全设置\r\n\t\t\t\t\tthis.enableWebViewSecurity();\r\n\t\t\t\t\t\r\n\t\t\t\t\t// 处理URL，添加安全头部\r\n\t\t\t\t\tthis.setSecureWebUrl(this.originalUrl);\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.error('URL解析错误:', e);\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '无效的链接',\r\n\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t});\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tuni.navigateBack();\r\n\t\t\t\t\t}, 1500);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tuni.showToast({\r\n\t\t\t\t\ttitle: '缺少URL参数',\r\n\t\t\t\t\ticon: 'none'\r\n\t\t\t\t});\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tuni.navigateBack();\r\n\t\t\t\t}, 1500);\r\n\t\t\t}\r\n\t\t},\r\n\t\tmounted() {\r\n\t\t\t// 添加监听器以禁用SharedArrayBuffer\r\n\t\t\tthis.disableSharedArrayBuffer();\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\t// 启用WebView安全设置\r\n\t\t\tenableWebViewSecurity() {\r\n\t\t\t\tif (typeof wx !== 'undefined' && wx.setWebViewSecurity) {\r\n\t\t\t\t\twx.setWebViewSecurity({\r\n\t\t\t\t\t\tenable: true,\r\n\t\t\t\t\t\tsuccess: () => {\r\n\t\t\t\t\t\t\tconsole.log('成功启用WebView安全模式');\r\n\t\t\t\t\t\t\tthis.securityEnabled = true;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\t\tconsole.error('启用WebView安全模式失败:', err);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t// 禁用SharedArrayBuffer相关功能\r\n\t\t\tdisableSharedArrayBuffer() {\r\n\t\t\t\t// 在小程序环境中\r\n\t\t\t\tif (typeof wx !== 'undefined') {\r\n\t\t\t\t\t// 添加WebView加载完成的处理\r\n\t\t\t\t\tif (wx.onWebViewLoad) {\r\n\t\t\t\t\t\twx.onWebViewLoad(() => {\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tconsole.log('WebView加载完成，应用安全措施');\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// 尝试注入脚本禁用SharedArrayBuffer\r\n\t\t\t\t\t\t\t\tthis.injectSecurityScript();\r\n\t\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\t\tconsole.error('WebView安全处理失败:', e);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t// 注入安全脚本\r\n\t\t\tinjectSecurityScript() {\r\n\t\t\t\tif (typeof wx !== 'undefined' && wx.evaluateWebView) {\r\n\t\t\t\t\t// 注入一段JS来处理SharedArrayBuffer\r\n\t\t\t\t\tconst securityScript = `\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t// 阻止使用SharedArrayBuffer\r\n\t\t\t\t\t\t\tif (typeof SharedArrayBuffer !== 'undefined') {\r\n\t\t\t\t\t\t\t\tconsole.warn('检测到SharedArrayBuffer，但已被安全策略禁用');\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// 添加必要的安全头\r\n\t\t\t\t\t\t\tconst meta = document.createElement('meta');\r\n\t\t\t\t\t\t\tmeta.httpEquiv = 'Cross-Origin-Embedder-Policy';\r\n\t\t\t\t\t\t\tmeta.content = 'require-corp';\r\n\t\t\t\t\t\t\tdocument.head.appendChild(meta);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst meta2 = document.createElement('meta');\r\n\t\t\t\t\t\t\tmeta2.httpEquiv = 'Cross-Origin-Opener-Policy';\r\n\t\t\t\t\t\t\tmeta2.content = 'same-origin';\r\n\t\t\t\t\t\t\tdocument.head.appendChild(meta2);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\ttrue; // 返回执行结果\r\n\t\t\t\t\t\t} catch(e) {\r\n\t\t\t\t\t\t\tconsole.error('安全脚本执行出错:', e);\r\n\t\t\t\t\t\t\tfalse; // 返回执行结果\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t`;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// 执行脚本\r\n\t\t\t\t\twx.evaluateWebView({\r\n\t\t\t\t\t\twebviewId: 'webviewId', // 可能需要根据实际情况获取\r\n\t\t\t\t\t\tscript: securityScript,\r\n\t\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\t\tconsole.log('安全脚本注入成功', res);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\t\tconsole.error('安全脚本注入失败:', err);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t// 设置安全的WebURL，处理跨源隔离问题\r\n\t\t\tsetSecureWebUrl(url) {\r\n\t\t\t\t// 检查URL是否有效\r\n\t\t\t\tif (!url) {\r\n\t\t\t\t\tthis.webUrl = '';\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// 确保URL有跨源隔离参数\r\n\t\t\t\t\tlet secureUrl = url;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// 如果URL中没有包含跨源隔离参数，则添加\r\n\t\t\t\t\tif (url.startsWith('http') && \r\n\t\t\t\t\t    !url.includes('coop=cross-origin') && \r\n\t\t\t\t\t    !url.includes('coep=require-corp')) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst separator = url.includes('?') ? '&' : '?';\r\n\t\t\t\t\t\tsecureUrl = `${url}${separator}coop=cross-origin&coep=require-corp`;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tconsole.log('使用安全URL:', secureUrl);\r\n\t\t\t\t\tthis.webUrl = secureUrl;\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.error('处理URL时出错:', e);\r\n\t\t\t\t\tthis.webUrl = url; // 降级处理，使用原始URL\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t// 处理web-view的消息\r\n\t\t\thandleMessage(event) {\r\n\t\t\t\tconsole.log('收到web-view消息:', event);\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\t// 处理web-view的错误\r\n\t\t\thandleError(error) {\r\n\t\t\t\tconsole.error('web-view加载错误:', error);\r\n\t\t\t\tuni.showToast({\r\n\t\t\t\t\ttitle: '页面加载出错',\r\n\t\t\t\t\ticon: 'none'\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style>\r\n\t.webview-container {\r\n\t\tposition: relative;\r\n\t\twidth: 100%;\r\n\t\theight: 100vh;\r\n\t}\r\n\t\r\n\t/* 加载中样式 */\r\n\t.loading {\r\n\t\tposition: absolute;\r\n\t\ttop: 50%;\r\n\t\tleft: 50%;\r\n\t\ttransform: translate(-50%, -50%);\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\talign-items: center;\r\n\t\tz-index: 50;\r\n\t}\r\n\t\r\n\t.loading-spinner {\r\n\t\twidth: 60rpx;\r\n\t\theight: 60rpx;\r\n\t\tborder: 4rpx solid #f0f0f0;\r\n\t\tborder-radius: 50%;\r\n\t\tborder-top-color: #fc3e2b;\r\n\t\tanimation: spin 1s linear infinite;\r\n\t\tmargin-bottom: 20rpx;\r\n\t}\r\n\t\r\n\t.loading-text {\r\n\t\tfont-size: 28rpx;\r\n\t\tcolor: #666666;\r\n\t}\r\n\t\r\n\t@keyframes spin {\r\n\t\t0% {\r\n\t\t\ttransform: rotate(0deg);\r\n\t\t}\r\n\t\t100% {\r\n\t\t\ttransform: rotate(360deg);\r\n\t\t}\r\n\t}\r\n</style> ","import MiniProgramPage from 'E:/Myxiangmu/chonggou/juzitongcheng/pages/webview/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","wx"],"mappings":";;AAkBC,MAAK,YAAU;AAAA,EACd,OAAO;AACN,WAAO;AAAA,MACN,QAAQ;AAAA,MACR,aAAa;AAAA,MACb,iBAAiB;AAAA,MACjB,UAAU;AAAA,IACX;AAAA,EACA;AAAA,EACD,OAAO,SAAS;AACf,QAAI,QAAQ,KAAK;AAChB,UAAI;AACH,aAAK,cAAc,mBAAmB,QAAQ,GAAG,KAAK;AAGtD,YAAI,QAAQ,OAAO;AAClB,eAAK,WAAW,mBAAmB,QAAQ,KAAK;AAEhDA,wBAAAA,MAAI,sBAAsB;AAAA,YACzB,OAAO,KAAK;AAAA,UACb,CAAC;AAAA,eACK;AAENA,wBAAAA,MAAI,sBAAsB;AAAA,YACzB,OAAO;AAAA,UACR,CAAC;AAAA,QACF;AAGA,aAAK,sBAAqB;AAG1B,aAAK,gBAAgB,KAAK,WAAW;AAAA,MACtC,SAAS,GAAG;AACXA,4EAAc,YAAY,CAAC;AAC3BA,sBAAAA,MAAI,UAAU;AAAA,UACb,OAAO;AAAA,UACP,MAAM;AAAA,QACP,CAAC;AACD,mBAAW,MAAM;AAChBA,wBAAG,MAAC,aAAY;AAAA,QAChB,GAAE,IAAI;AAAA,MACR;AAAA,WACM;AACNA,oBAAAA,MAAI,UAAU;AAAA,QACb,OAAO;AAAA,QACP,MAAM;AAAA,MACP,CAAC;AACD,iBAAW,MAAM;AAChBA,sBAAG,MAAC,aAAY;AAAA,MAChB,GAAE,IAAI;AAAA,IACR;AAAA,EACA;AAAA,EACD,UAAU;AAET,SAAK,yBAAwB;AAAA,EAC7B;AAAA,EACD,SAAS;AAAA;AAAA,IAER,wBAAwB;AACvB,UAAI,OAAOC,cAAC,SAAM,eAAeA,cAAAA,KAAG,oBAAoB;AACvDA,sBAAAA,KAAG,mBAAmB;AAAA,UACrB,QAAQ;AAAA,UACR,SAAS,MAAM;AACdD,0BAAAA,MAAA,MAAA,OAAA,iCAAY,iBAAiB;AAC7B,iBAAK,kBAAkB;AAAA,UACvB;AAAA,UACD,MAAM,CAAC,QAAQ;AACdA,0BAAA,MAAA,MAAA,SAAA,iCAAc,oBAAoB,GAAG;AAAA,UACtC;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACA;AAAA;AAAA,IAGD,2BAA2B;AAE1B,UAAI,OAAOC,cAAC,SAAM,aAAa;AAE9B,YAAIA,cAAAA,KAAG,eAAe;AACrBA,wBAAE,KAAC,cAAc,MAAM;AACtB,gBAAI;AACHD,4BAAAA,MAAA,MAAA,OAAA,kCAAY,oBAAoB;AAGhC,mBAAK,qBAAoB;AAAA,YAC1B,SAAS,GAAG;AACXA,4BAAA,MAAA,MAAA,SAAA,kCAAc,kBAAkB,CAAC;AAAA,YAClC;AAAA,UACD,CAAC;AAAA,QACF;AAAA,MACD;AAAA,IACA;AAAA;AAAA,IAGD,uBAAuB;AACtB,UAAI,OAAOC,cAAC,SAAM,eAAeA,cAAAA,KAAG,iBAAiB;AAEpD,cAAM,iBAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA0BvBA,sBAAAA,KAAG,gBAAgB;AAAA,UAClB,WAAW;AAAA;AAAA,UACX,QAAQ;AAAA,UACR,SAAS,CAAC,QAAQ;AACjBD,0BAAY,MAAA,MAAA,OAAA,kCAAA,YAAY,GAAG;AAAA,UAC3B;AAAA,UACD,MAAM,CAAC,QAAQ;AACdA,0BAAc,MAAA,MAAA,SAAA,kCAAA,aAAa,GAAG;AAAA,UAC/B;AAAA,QACD,CAAC;AAAA,MACF;AAAA,IACA;AAAA;AAAA,IAGD,gBAAgB,KAAK;AAEpB,UAAI,CAAC,KAAK;AACT,aAAK,SAAS;AACd;AAAA,MACD;AAEA,UAAI;AAEH,YAAI,YAAY;AAGhB,YAAI,IAAI,WAAW,MAAM,KACrB,CAAC,IAAI,SAAS,mBAAmB,KACjC,CAAC,IAAI,SAAS,mBAAmB,GAAG;AAEvC,gBAAM,YAAY,IAAI,SAAS,GAAG,IAAI,MAAM;AAC5C,sBAAY,GAAG,GAAG,GAAG,SAAS;AAAA,QAC/B;AAEAA,sBAAY,MAAA,MAAA,OAAA,kCAAA,YAAY,SAAS;AACjC,aAAK,SAAS;AAAA,MACf,SAAS,GAAG;AACXA,6EAAc,aAAa,CAAC;AAC5B,aAAK,SAAS;AAAA,MACf;AAAA,IACA;AAAA;AAAA,IAGD,cAAc,OAAO;AACpBA,oBAAA,MAAA,MAAA,OAAA,kCAAY,iBAAiB,KAAK;AAAA,IAClC;AAAA;AAAA,IAGD,YAAY,OAAO;AAClBA,oBAAA,MAAA,MAAA,SAAA,kCAAc,iBAAiB,KAAK;AACpCA,oBAAAA,MAAI,UAAU;AAAA,QACb,OAAO;AAAA,QACP,MAAM;AAAA,MACP,CAAC;AAAA,IACF;AAAA,EACD;AACD;;;;;;;;;;;ACrMD,GAAG,WAAW,eAAe;"}