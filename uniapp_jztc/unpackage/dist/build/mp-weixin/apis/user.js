"use strict";const e=require("../common/vendor.js"),t=require("../utils/request.js"),r=require("../utils/constants.js");function n(e){return t.post(r.API_PATHS.WXAPP_LOGIN,e).catch((e=>{throw e}))}function a(){return new Promise(((t,r)=>{e.index.login({provider:"weixin",success:e=>{if(e.code)t(e.code);else{r({message:"获取微信登录凭证失败",res:e})}},fail:e=>{r(e||{message:"微信登录失败"})}})}))}function i(t){return new Promise(((r,n)=>{e.index.getImageInfo({src:t,success:t=>{const a=200,i=e.index.createCanvasContext("avatarCanvas");i.clearRect(0,0,a,a),i.drawImage(t.path,0,0,a,a);let s=setTimeout((()=>{n(new Error("Canvas绘制超时"))}),2e3);i.draw(!1,(()=>{clearTimeout(s),e.index.canvasToTempFilePath({canvasId:"avatarCanvas",fileType:"jpg",quality:.8,success:t=>{e.index.getFileSystemManager().readFile({filePath:t.tempFilePath,encoding:"base64",success:e=>{const t="data:image/jpeg;base64,"+e.data;r(t)},fail:e=>{n(new Error("读取图片文件失败: "+JSON.stringify(e)))}})},fail:e=>{n(new Error("导出图片失败: "+JSON.stringify(e)))}})}))},fail:e=>{n(new Error("获取图片信息失败: "+JSON.stringify(e)))}})}))}function s(){return t.get("/wx/client/butler/image")}const o=Object.freeze(Object.defineProperty({__proto__:null,cancelOrder:function(e){return t.post("/wx/client/order/cancel",e)},getButlerImage:s,getClientInfo:function(){return t.get(r.API_PATHS.CLIENT_INFO).catch((e=>{throw e}))},getImageBase64:i,getOrderDetail:function(e){return t.get("/wx/client/order/detail",e)},getOrderList:function(e){return t.get("/wx/client/order/list",e)},getWxLoginCode:a,getWxUserInfo:function(){return new Promise(((t,r)=>{e.index.getUserProfile({desc:"用于完善用户资料",success:e=>{e.userInfo?t(e.userInfo):r({message:"获取用户信息失败"})},fail:e=>{r(e||{message:"用户拒绝授权"})}})}))},updateClientProfile:function(e){return t.put(r.API_PATHS.CLIENT_UPDATE_PROFILE,e).catch((e=>{throw e}))},uploadAvatar:function(e){return new Promise((async(n,a)=>{try{const a=await i(e);n(await t.put(r.API_PATHS.CLIENT_UPDATE_PROFILE,{avatarUrl:a}))}catch(s){a(s)}}))},wxappLogin:n},Symbol.toStringTag,{value:"Module"}));exports.getButlerImage=s,exports.getWxLoginCode=a,exports.userApi=o,exports.wxappLogin=n;
