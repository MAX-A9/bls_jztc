"use strict";const e=require("../../common/vendor.js"),t=require("../../apis/content.js"),i=require("../../utils/date.js"),n=require("../../common/assets.js"),o={name:"ContentList",props:{categoryId:{type:[Number,String],default:""}},data:()=>({contentList:[],loading:!1,hasMore:!0,page:1,pageSize:10,regionId:0,currentCategory:"",isInitialized:!1}),created(){const t=e.index.getStorageSync("currentLocationId")||0;t&&(this.regionId=t,console.log("组件创建时，从本地存储初始化区域ID:",this.regionId)),e.index.$on("locationChanged",this.handleLocationChanged),console.log("已注册locationChanged事件监听")},mounted(){this.$nextTick((()=>{this.init()}))},beforeDestroy(){e.index.$off("locationChanged",this.handleLocationChanged)},methods:{init(){if(this.isInitialized&&this.contentList.length>0)return void console.log("内容列表已初始化，跳过重复初始化");const t=e.index.getStorageSync("currentLocationId")||0;this.regionId&&0!==this.regionId||!t||(this.regionId=t,console.log("初始化时，从本地存储更新区域ID:",this.regionId)),this.regionId&&0!==this.regionId?(console.log("初始化时，开始加载内容列表数据..."),this.resetAndLoad(),this.isInitialized=!0):console.log("初始化时，未找到有效的区域ID")},formatPublishTime:e=>i.formatTimeAgo(e),handleItemClick(t){e.index.navigateTo({url:`/pages/content/detail?id=${t.id}&category=${t.category}`,success:()=>{console.log("跳转到详情页:",t)},fail:e=>{console.error("跳转失败:",e)}})},handleCategoryChange(e){this.currentCategory=e,this.resetAndLoad()},handleLocationChanged(e){console.log("位置变更事件触发，接收到的regionId:",e.regionId);const t=e.regionId||0;t?this.regionId!==t?(console.log("地区ID已更新:",this.regionId,"->",t),this.regionId=t,this.resetAndLoad()):console.log("地区ID未变化，保持当前值:",this.regionId):console.error("接收到无效的regionId:",t)},resetAndLoad(){console.log("重置内容列表，当前区域ID:",this.regionId),this.page=1,this.contentList=[],this.hasMore=!0,this.loadData()},loadMore(){!this.loading&&this.hasMore&&(this.page++,this.loadData())},async loadData(){if(!this.loading)try{this.loading=!0;const n=e.index.getStorageSync("currentLocationId")||0;if(console.log("从本地存储获取的区域ID:",n),!this.regionId&&n&&(console.log("使用本地存储区域ID更新组件regionId:",n),this.regionId=n),!this.regionId)throw e.index.showToast({title:"请先选择地区",icon:"none"}),new Error("未选择地区");const o={regionId:this.regionId,page:this.page,pageSize:this.pageSize};this.currentCategory&&(o.category=this.currentCategory),console.log("加载内容列表，参数:",o);const s=await t.getRegionContentList(o);if(0!==s.code||!s.data)throw new Error(s.message||"获取内容列表失败");{const{list:e=[],total:t=0}=s.data;let n=e.map((e=>({...e,publishTimeFormatted:this.formatPublishTime(e.publishTime)})));n.sort(((e,t)=>{if(e.isTop&&!t.isTop)return-1;if(!e.isTop&&t.isTop)return 1;let n=0,o=0;try{if(e.publishTime&&"string"==typeof e.publishTime&&e.publishTime.includes(" ")){const t=e.publishTime.split(" ")[0].split("-"),i=e.publishTime.split(" ")[1].split(":");n=new Date(parseInt(t[0]),parseInt(t[1])-1,parseInt(t[2]),parseInt(i[0]),parseInt(i[1]),parseInt(i[2])).getTime()}else n=i.getTimestamp(e.publishTime);if(t.publishTime&&"string"==typeof t.publishTime&&t.publishTime.includes(" ")){const e=t.publishTime.split(" ")[0].split("-"),i=t.publishTime.split(" ")[1].split(":");o=new Date(parseInt(e[0]),parseInt(e[1])-1,parseInt(e[2]),parseInt(i[0]),parseInt(i[1]),parseInt(i[2])).getTime()}else o=i.getTimestamp(t.publishTime)}catch(s){console.error("日期解析错误:",s,e.publishTime,t.publishTime),n=o=Date.now()}return o-n})),1===this.page?this.contentList=n:this.contentList=[...this.contentList,...n],this.hasMore=this.contentList.length<t,console.log(`加载了${e.length}条数据，总共${t}条，使用的区域ID:${this.regionId}`),this.$parent&&!0===this.$parent.refreshing&&this.notifyRefreshComplete()}}catch(n){console.error("加载内容列表失败:",n),e.index.showToast({title:"加载失败，请重试",icon:"none",duration:2e3})}finally{this.loading=!1}},notifyRefreshComplete(){this.$emit("refreshComplete"),this.$parent&&!0===this.$parent.refreshing&&(this.$parent.refreshing=!1,console.log("内容加载完成，关闭刷新状态"))}}};const s=e._export_sfc(o,[["render",function(t,i,o,s,r,a){return e.e({a:r.loading&&0===r.contentList.length},(r.loading&&r.contentList.length,{}),{b:e.f(r.contentList,((t,i,n)=>e.e({a:t.isTop},(t.isTop,{}),{b:e.t(t.category),c:e.t(t.title),d:e.t(t.publisher),e:e.t(t.publishTimeFormatted),f:e.n({"full-width":!t.image}),g:t.image},t.image?{h:t.image}:{},{i:i,j:e.o((e=>a.handleItemClick(t)),i)}))),c:r.contentList.length>0},r.contentList.length>0?e.e({d:r.hasMore&&!r.loading},(r.hasMore&&r.loading,{}),{e:r.loading&&r.contentList.length>0},(r.loading&&r.contentList.length,{}),{f:!r.hasMore&&r.contentList.length>0},(!r.hasMore&&r.contentList.length,{})):{},{g:!r.loading&&0===r.contentList.length},r.loading||0!==r.contentList.length?{}:{h:n._imports_0})}]]);wx.createComponent(s);
