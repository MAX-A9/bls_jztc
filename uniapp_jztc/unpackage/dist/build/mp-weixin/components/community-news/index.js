"use strict";const e=require("../../common/vendor.js"),t=require("../../apis/content.js"),i=require("../../common/assets.js"),o={name:"CommunityNews",props:{categoryId:{type:[Number,String],default:0}},data:()=>({newsList:[],loading:!1,hasMore:!0,page:1,pageSize:10,regionId:0,currentCategoryId:0,defaultImage:"/static/images/default-idle.png"}),created(){this.currentCategoryId=this.categoryId;const t=e.index.getStorageSync("currentLocationId")||0;t&&(this.regionId=t,console.log("闲置列表组件创建时，从本地存储初始化区域ID:",this.regionId)),e.index.$on("idleCategoryChanged",this.handleCategoryChanged),e.index.$on("locationChanged",this.handleLocationChanged),this.loadData()},beforeDestroy(){e.index.$off("idleCategoryChanged",this.handleCategoryChanged),e.index.$off("locationChanged",this.handleLocationChanged)},methods:{handleCategoryChanged(e){console.log("接收到分类变更事件:",e),e&&void 0!==e.categoryId&&(this.currentCategoryId=e.categoryId,this.resetAndLoad())},handleLocationChanged(e){console.log("位置变更事件触发，接收到的regionId:",e.regionId);const t=e.regionId||0;t?this.regionId!==t?(console.log("地区ID已更新:",this.regionId,"->",t),this.regionId=t,this.resetAndLoad()):console.log("地区ID未变化，保持当前值:",this.regionId):console.error("接收到无效的regionId:",t)},resetAndLoad(){this.page=1,this.newsList=[],this.hasMore=!0,this.loadData()},async loadData(){if(!this.loading)try{this.loading=!0;const i=e.index.getStorageSync("currentLocationId")||0;!this.regionId&&i&&(this.regionId=i);const o={regionId:this.regionId,page:this.page,pageSize:this.pageSize,category:this.currentCategoryId};console.log("加载闲置物品列表，参数:",o);const s=await t.getRegionIdleList(o);if(0!==s.code||!s.data)throw new Error(s.message||"获取闲置物品列表失败");{const{list:e=[],total:t=0}=s.data,i=e.map((e=>({id:e.id,title:e.title||"",desc:e.summary||"暂无描述",location:e.tradePlace||"未知地点",price:e.price||0,image:e.image||this.defaultImage,wantCount:e.likes||0})));1===this.page?this.newsList=i:this.newsList=[...this.newsList,...i],this.hasMore=this.newsList.length<t,console.log(`加载了${e.length}条闲置物品数据，总共${t}条`),this.$parent&&!0===this.$parent.isRefreshing&&this.notifyRefreshComplete()}}catch(i){console.error("加载闲置物品列表失败:",i),1===this.page&&0===this.newsList.length&&(console.log("使用默认数据"),this.useDefaultData()),e.index.showToast({title:"加载失败，请重试",icon:"none",duration:2e3})}finally{this.loading=!1}},notifyRefreshComplete(){this.$parent&&!0===this.$parent.isRefreshing&&(this.$parent.isRefreshing=!1,console.log("内容加载完成，关闭刷新状态"))},loadMore(){!this.loading&&this.hasMore&&(this.page++,this.loadData())},handleImageError(e){this.newsList[e].image=this.defaultImage},useDefaultData(){this.newsList=[],this.hasMore=!1},handleNewsClick(t){this.recordBrowseHistory(t.id),e.index.navigateTo({url:`/pages/community/detail?id=${t.id}`,success:()=>{console.log("跳转到闲置详情页:",t)},fail:e=>{console.error("跳转失败:",e)}})},async recordBrowseHistory(e){if(e)try{(await t.addBrowseRecord(e,"idle")).code}catch(i){console.error("记录闲置浏览历史异常:",i)}else console.error("记录浏览历史失败: 内容ID为空")}}};const s=e._export_sfc(o,[["render",function(t,o,s,n,a,r){return e.e({a:a.loading&&0===a.newsList.length},(a.loading&&a.newsList.length,{}),{b:!a.loading||a.newsList.length>0},!a.loading||a.newsList.length>0?{c:e.f(a.newsList,((t,i,o)=>({a:t.image||a.defaultImage,b:e.o((e=>r.handleImageError(i)),i),c:e.t(t.title),d:e.t(t.desc),e:e.t(t.location),f:e.t(t.price),g:e.t(t.wantCount),h:i,i:e.o((e=>r.handleNewsClick(t)),i)})))}:{},{d:a.newsList.length>0},a.newsList.length>0?e.e({e:a.hasMore&&!a.loading},(a.hasMore&&a.loading,{}),{f:a.loading&&a.newsList.length>0},(a.loading&&a.newsList.length,{}),{g:!a.hasMore&&a.newsList.length>0},(!a.hasMore&&a.newsList.length,{})):{},{h:!a.loading&&0===a.newsList.length},a.loading||0!==a.newsList.length?{}:{i:i._imports_0})}]]);wx.createComponent(s);
