"use strict";const e=require("../apis/index.js"),t=require("./storage.js"),r=require("./constants.js");function n(){return!!t.getToken()}async function o(){try{const n=await e.user.getClientInfo();if(n&&n.code===r.API_CODE.SUCCESS&&n.data){const e=n.data;return e.id&&!e.clientId&&(e.clientId=e.id),t.setUserInfo(e),e}throw new Error(n.message||"获取客户信息失败")}catch(n){return Promise.reject(n)}}async function a(){try{const n={code:await e.user.getWxLoginCode()},a=await e.user.wxappLogin(n);if(a&&a.code===r.API_CODE.SUCCESS&&a.data&&a.data.token){t.setToken(a.data.token);const e=await o();return{...a.data,userInfo:e}}throw new Error(a.message||"登录失败，返回数据不完整")}catch(n){return Promise.reject(n)}}exports.checkAndAutoLogin=async function(){if(n()){const r=t.getUserInfo(),n=r&&(r.clientId||r.id),a=r&&r.realName;if(n&&a)return{token:t.getToken(),userInfo:r};try{const e=await o();return{token:t.getToken(),userInfo:e}}catch(e){t.clearUserLoginState()}}try{const e=await a();if(!e.userInfo&&e.token)try{const t=await o();return{...e,userInfo:t}}catch(r){return e}return e}catch(s){return Promise.reject(s)}},exports.fetchAndSaveUserInfo=o,exports.fullLogin=async function(){try{const n=await e.user.getWxLoginCode(),a={code:n,userInfo:await e.user.getWxUserInfo()},s=await e.user.wxappLogin(a);if(s&&s.code===r.API_CODE.SUCCESS&&s.data&&s.data.token){t.setToken(s.data.token);const e=await o();return{...s.data,userInfo:e}}throw new Error(s.message||"登录失败，返回数据不完整")}catch(n){return Promise.reject(n)}},exports.isLoggedIn=n,exports.logout=function(){t.clearUserLoginState()},exports.silentLogin=a;
