"use strict";const e=require("../common/vendor.js"),t=require("./storage.js"),o=require("./constants.js");function s(s){return new Promise(((r,n)=>{const a=t.getToken(),u=/^(http|https):\/\//.test(s.url)?s.url:o.API_BASE_URL+s.url,i={"Content-Type":s.contentType||"application/json",...s.header};a&&(i.Authorization=`Bearer ${a}`);let d=null;const c=new Promise(((e,t)=>{d=setTimeout((()=>{t({message:"请求超时，请检查网络",code:"TIMEOUT"}),m&&m.abort()}),s.timeout||o.API_TIMEOUT)})),m=e.index.request({url:u,data:s.data,method:s.method||"GET",header:i,success:t=>{clearTimeout(d),t.statusCode>=200&&t.statusCode<300?r(t.data):401===t.statusCode?(e.index.showToast({title:"请先登录",icon:"none"}),n({code:401,message:"未授权或token已过期"})):n(t.data||{message:`请求失败，状态码：${t.statusCode}`})},fail:e=>{clearTimeout(d),n(e||{message:"网络请求失败"})},complete:()=>{s.complete&&s.complete()}});return Promise.race([m,c])}))}exports.del=function(e,t={},o={}){return s({url:e,data:t,method:"DELETE",...o})},exports.get=function(s,r={},n=!1){return new Promise(((a,u)=>{e.index.request({url:o.API_BASE_URL+s,method:"GET",data:r,header:{"Content-Type":"application/json",...!n&&{Authorization:`Bearer ${t.getToken()}`}},success:e=>{200===e.statusCode?a(e.data):u(e)},fail:e=>{u(e)}})}))},exports.post=function(e,t={},o={}){return s({url:e,data:t,method:"POST",...o})},exports.put=function(e,t={},o={}){return s({url:e,data:t,method:"PUT",...o})},exports.request=s;
