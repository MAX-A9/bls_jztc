"use strict";const s=require("../apis/message.js");const t=new class{constructor(){this.pollingTimer=null,this.pollingInterval=5e3,this.chatPollingInterval=3e3,this.isPolling=!1,this.listeners={unreadCount:[],chatMessages:[],conversationList:[]},this.chatParams=null,this.conversationParams=null,this.globalPaused=!1,this.previousPollingState=!1,this.whitelistPages=["/pages/chat/detail"],this.currentPage=""}setCurrentPage(s){this.currentPage=s,console.log("当前页面路径:",s),this.isPageInWhitelist(s)&&this.globalPaused&&(console.log("当前页面在白名单中，恢复轮询"),this.resumePollingForWhitelist())}isPageInWhitelist(s){return this.whitelistPages.some((t=>s&&-1!==s.indexOf(t)))}resumePollingForWhitelist(){if(this.globalPaused&&!this.isPolling&&this.previousPollingState){console.log("白名单页面特殊处理：恢复轮询但保持全局暂停状态"),this.isPolling=!0,this.poll();const s=this.chatParams?this.chatPollingInterval:this.pollingInterval;this.pollingTimer=setInterval((()=>{this.poll()}),s)}}setPollingInterval(s){this.pollingInterval=s,this.isPolling&&(this.stopPolling(),this.startPolling())}setChatPollingInterval(s){this.chatPollingInterval=s,this.isPolling&&this.chatParams&&(this.stopPolling(),this.startPolling())}startPolling(){if(this.isPolling||this.globalPaused)return;this.isPolling=!0,this.poll();const s=this.chatParams?this.chatPollingInterval:this.pollingInterval;this.pollingTimer=setInterval((()=>{this.poll()}),s),console.log(`消息轮询已启动，间隔 ${s} ms`)}stopPolling(){this.pollingTimer&&(clearInterval(this.pollingTimer),this.pollingTimer=null),this.isPolling=!1,console.log("消息轮询已停止")}pausePollingGlobally(){this.globalPaused||(this.isPageInWhitelist(this.currentPage)?console.log("当前页面在白名单中，不执行全局暂停"):(this.previousPollingState=this.isPolling,this.globalPaused=!0,this.isPolling&&(this.stopPolling(),console.log("消息轮询已全局暂停"))))}resumePollingGlobally(){this.globalPaused&&(this.globalPaused=!1,this.previousPollingState&&(this.startPolling(),console.log("消息轮询已全局恢复")))}async poll(){this.globalPaused&&!this.isPageInWhitelist(this.currentPage)||(this.listeners.unreadCount.length>0&&this.pollUnreadCount(),this.chatParams&&this.listeners.chatMessages.length>0&&this.pollChatMessages(),this.conversationParams&&this.listeners.conversationList.length>0&&this.pollConversationList())}async pollUnreadCount(){try{const t=await s.getUnreadCount();if(t&&0===t.code){const s=t.data.unreadCount||0;this.listeners.unreadCount.forEach((t=>{t(s)}))}}catch(t){console.error("获取未读消息数失败:",t)}}async pollChatMessages(){if(this.chatParams&&this.chatParams.targetId)try{const t=await s.getMessageList({targetId:this.chatParams.targetId,page:1,size:20,lastId:this.chatParams.lastId||0});t&&0===t.code&&this.listeners.chatMessages.forEach((s=>{s(t.data)}))}catch(t){console.error("获取聊天消息失败:",t)}}async pollConversationList(){if(this.conversationParams)try{const t=(new Date).getTime(),i=await s.getConversationList({page:this.conversationParams.page||1,size:this.conversationParams.size||20,_t:t});i&&0===i.code&&this.listeners.conversationList.forEach((s=>{s(i.data)}))}catch(t){console.error("获取会话列表失败:",t)}}addUnreadCountListener(s){return"function"!=typeof s?()=>{}:(this.listeners.unreadCount.push(s),this.isPolling?this.pollUnreadCount():this.startPolling(),()=>{this.removeUnreadCountListener(s)})}removeUnreadCountListener(s){const t=this.listeners.unreadCount.indexOf(s);-1!==t&&this.listeners.unreadCount.splice(t,1),this.checkAndStopPolling()}setChatParams(s,t){return this.chatParams=s,"function"==typeof t?(this.listeners.chatMessages.push(t),this.isPolling&&this.stopPolling(),this.startPolling(),()=>{this.removeChatMessageListener(t)}):()=>{}}updateChatParams(s){this.chatParams?this.chatParams={...this.chatParams,...s}:this.chatParams=s}removeChatMessageListener(s){const t=this.listeners.chatMessages.indexOf(s);-1!==t&&this.listeners.chatMessages.splice(t,1),0===this.listeners.chatMessages.length&&(this.chatParams=null,this.adjustPollingState())}setConversationParams(s,t){return this.conversationParams=s,"function"==typeof t?(this.listeners.conversationList.push(t),this.isPolling?this.pollConversationList():this.startPolling(),()=>{this.removeConversationListListener(t)}):()=>{}}updateConversationParams(s){this.conversationParams?this.conversationParams={...this.conversationParams,...s}:this.conversationParams=s}removeConversationListListener(s){const t=this.listeners.conversationList.indexOf(s);-1!==t&&this.listeners.conversationList.splice(t,1),0===this.listeners.conversationList.length&&(this.conversationParams=null,this.adjustPollingState())}adjustPollingState(){this.listeners.unreadCount.length>0||this.listeners.chatMessages.length>0||this.listeners.conversationList.length>0?(this.listeners.chatMessages.length,this.isPolling&&this.stopPolling(),this.startPolling()):this.stopPolling()}checkAndStopPolling(){this.listeners.unreadCount.length>0||this.listeners.chatMessages.length>0||this.listeners.conversationList.length>0||this.stopPolling()}clearListeners(){this.listeners.unreadCount=[],this.listeners.chatMessages=[],this.listeners.conversationList=[],this.chatParams=null,this.conversationParams=null,this.stopPolling()}};exports.messagePollingService=t;
