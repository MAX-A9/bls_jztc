"use strict";const e=require("../../common/vendor.js"),t=require("../../apis/message.js"),s=require("../../utils/message-polling.js"),a={data(){return{chatId:null,chatInfo:{id:0,name:"",avatar:""},messageList:[],inputMessage:"",showMorePanel:!1,inputFocus:!1,currentDate:this.formatDate(new Date),keyboardVisible:!1,userAvatar:"",pagination:{page:1,size:20,totalCount:0,totalPage:0},isLoading:!1,nickName:"",_markingAsRead:!1,chatMessageUnsubscribe:null}},onLoad(t){if(t.id||t.sessionId){this.chatId=t.id||t.sessionId,t.nickName&&(this.nickName=decodeURIComponent(t.nickName)),this.loadChatInfo(),this.loadChatHistory();const a=e.index.getStorageSync("USER_INFO")||{};this.userAvatar=a.avatarUrl||"/static/demo/avatar-self.jpg",s.messagePollingService.setCurrentPage("/pages/chat/detail")}},onReady(){this.chatInfo.name&&e.index.setNavigationBarTitle({title:this.chatInfo.name})},onKeyboardHeightChange(e){this.keyboardVisible=e.height>0,this.keyboardVisible&&(this.showMorePanel=!1)},onShow(){this.chatId&&(console.log("聊天详情页面显示，chatId:",this.chatId),s.messagePollingService.setCurrentPage("/pages/chat/detail"),this.messageList.length>0&&this.markMessagesAsRead(),this.startChatPolling())},onNavigationBarButtonTap(e){0===e.index&&this.showMoreOptions()},onHide(){console.log("聊天详情页面隐藏")},onUnload(){console.log("聊天详情页面卸载"),this.stopChatPolling(),s.messagePollingService.setCurrentPage("")},methods:{loadChatInfo(){this.nickName?(this.chatInfo={id:this.chatId,name:this.nickName,avatar:"/static/images/default-avatar.png"},e.index.setNavigationBarTitle({title:this.chatInfo.name})):(this.chatInfo={id:this.chatId,name:"用户"+this.chatId,avatar:"/static/images/default-avatar.png"},e.index.setNavigationBarTitle({title:this.chatInfo.name}))},async loadChatHistory(){if(this.chatId&&!this.isLoading){this.isLoading=!0;try{e.index.showLoading({title:"加载中...",mask:!0});const s=await t.getMessageList({targetId:this.chatId,page:this.pagination.page,size:this.pagination.size});if(!s||0!==s.code)throw new Error((null==s?void 0:s.message)||"获取消息列表失败");{const{list:e,totalCount:t,totalPage:a,currentPage:i,size:n}=s.data;if(this.pagination={page:i,size:n,totalCount:t,totalPage:a},e&&e.length>0){const t=e.map((e=>{const t=e.createdAt?e.createdAt.replace(/-/g,"/"):"",s=t?new Date(t).getTime():0;return{type:"text",content:e.content,time:this.formatMessageTime(e.createdAt),isSelf:e.isSelf,id:e.id,senderId:e.senderId,senderName:e.senderName,senderAvatar:e.senderAvatar||"/static/images/default-avatar.png",receiverId:e.receiverId,receiverName:e.receiverName,receiverAvatar:e.receiverAvatar||"/static/images/default-avatar.png",isRead:e.isRead,createdAt:s}}));t.sort(((e,t)=>e.id-t.id)),this.messageList=t,this.markMessagesAsRead()}else this.messageList=[]}}catch(s){console.error("加载聊天记录失败:",s),e.index.showToast({title:"加载聊天记录失败",icon:"none"})}finally{this.isLoading=!1,e.index.hideLoading()}}},formatMessageTime(e){if(!e)return"";let t;if("string"==typeof e){const s=e.replace(/-/g,"/");t=new Date(s)}else t=new Date(e);return isNaN(t.getTime())?(console.error("Invalid date format:",e),""):this.formatTime(t)},showMoreOptions(){e.index.showActionSheet({itemList:["清空聊天记录","投诉","加入黑名单"],success:e=>{switch(e.tapIndex){case 0:this.clearChatHistory();break;case 1:this.reportUser();break;case 2:this.blockUser()}}})},clearChatHistory(){e.index.showModal({title:"提示",content:"确定要清空聊天记录吗？",success:t=>{t.confirm&&(this.messageList=[],e.index.showToast({title:"已清空聊天记录",icon:"success"}))}})},reportUser(){e.index.showToast({title:"已提交投诉",icon:"success"})},blockUser(){e.index.showModal({title:"提示",content:"确定要将该用户加入黑名单吗？",success:t=>{t.confirm&&(e.index.showToast({title:"已加入黑名单",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500))}})},handleChatMessages(e){if(!e||!e.list)return;const{list:t}=e;if(t&&t.length>0){const e=t.filter((e=>!this.messageList.some((t=>t.id===e.id)))).map((e=>{const t=e.createdAt?e.createdAt.replace(/-/g,"/"):"",s=t?new Date(t).getTime():0;return{type:"text",content:e.content,time:this.formatMessageTime(e.createdAt),isSelf:e.isSelf,id:e.id,senderId:e.senderId,senderName:e.senderName,senderAvatar:e.senderAvatar||"/static/images/default-avatar.png",receiverId:e.receiverId,receiverName:e.receiverName,receiverAvatar:e.receiverAvatar||"/static/images/default-avatar.png",isRead:e.isRead,createdAt:s}}));e.length>0&&(e.sort(((e,t)=>e.id-t.id)),this.messageList=[...this.messageList,...e],this.markMessagesAsRead())}},startChatPolling(){if(!this.chatId)return;let e=0;if(this.messageList.length>0){e=this.messageList[this.messageList.length-1].id||0}this.stopChatPolling(),this.chatMessageUnsubscribe=s.messagePollingService.setChatParams({targetId:this.chatId,lastId:e},this.handleChatMessages)},stopChatPolling(){this.chatMessageUnsubscribe&&(this.chatMessageUnsubscribe(),this.chatMessageUnsubscribe=null)},updateLastId(e){e&&this.chatId&&s.messagePollingService.updateChatParams({lastId:e})},async sendTextMessage(){if(!this.inputMessage.trim())return;const s=this.inputMessage.trim();this.inputMessage="";try{const e=new Date,a={type:"text",content:s,time:this.formatTime(e),isSelf:!0,sending:!0,createdAt:e.getTime(),senderAvatar:this.userAvatar||"/static/images/default-avatar.png"};this.messageList.push(a),this.showMorePanel=!1;const i=await t.sendMessage({content:s,receiverId:parseInt(this.chatId)});if(!i||0!==i.code)throw new Error((null==i?void 0:i.message)||"发送消息失败");{const e=this.messageList.length-1;e>=0&&(this.messageList[e].sending=!1,i.data&&i.data.id&&(this.messageList[e].id=i.data.id,this.updateLastId(i.data.id)))}}catch(a){console.error("发送消息失败:",a);const t=this.messageList.length-1;t>=0&&this.messageList[t].sending&&(this.messageList[t].sending=!1,this.messageList[t].failed=!0),e.index.showToast({title:"发送失败，请重试",icon:"none"})}},toggleMorePanel(){this.showMorePanel=!this.showMorePanel,this.inputFocus=!1},hideMorePanel(){this.showMorePanel&&(this.showMorePanel=!1)},focusInput(){this.inputFocus=!0,this.hideMorePanel()},onInputFocus(e){this.keyboardVisible=!0},onInputBlur(){setTimeout((()=>{this.keyboardVisible=!1}),100)},chooseImage(){e.index.chooseImage({count:1,success:t=>{const s=t.tempFilePaths[0],a=new Date;this.messageList.push({type:"image",content:s,time:this.formatTime(a),isSelf:!0,sending:!0,createdAt:a.getTime()}),this.showMorePanel=!1,e.index.showToast({title:"图片功能开发中",icon:"none"})}})},chooseLocation(){e.index.showToast({title:"选择位置功能开发中",icon:"none"}),this.showMorePanel=!1},shareProduct(){e.index.showToast({title:"分享商品功能开发中",icon:"none"}),this.showMorePanel=!1},previewImage(t){const s=this.messageList.filter((e=>"image"===e.type)).map((e=>e.content));e.index.previewImage({current:t,urls:s})},formatDate:e=>`${e.getFullYear()}年${e.getMonth()+1}月${e.getDate()}日`,formatTime:e=>`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`,async markMessagesAsRead(){if(this.chatId){if(!this._markingAsRead){this._markingAsRead=!0;try{console.log("标记消息为已读，targetId:",this.chatId);let e=this.chatId;"string"==typeof e&&(e=parseInt(e));const s=await t.markMessageRead({targetId:e});s&&0===s.code?(console.log("消息已成功标记为已读"),this.messageList.forEach((e=>{e.isSelf||(e.isRead=!0)}))):console.error("标记消息为已读失败:",(null==s?void 0:s.message)||"未知错误")}catch(e){console.error("标记消息为已读请求失败:",e)}finally{this._markingAsRead=!1}}}else console.error("无法标记消息为已读：chatId不存在")}}};if(!Array){e.resolveComponent("uni-icons")()}Math;const i=e._export_sfc(a,[["render",function(t,s,a,i,n,o){return e.e({a:e.t(n.currentDate),b:e.f(n.messageList,((t,s,a)=>e.e({a:!t.isSelf},t.isSelf?{}:{b:t.senderAvatar},{c:"text"===t.type},"text"===t.type?{d:e.t(t.content)}:"image"===t.type?{f:t.content,g:e.o((e=>o.previewImage(t.content)),s)}:"product"===t.type?{i:t.content.image,j:e.t(t.content.title),k:e.t(t.content.price)}:{},{e:"image"===t.type,h:"product"===t.type,l:t.isSelf},t.isSelf?{m:t.senderAvatar}:{},{n:s,o:e.n(t.isSelf?"self":"other"),p:"msg-"+s}))),c:"msg-"+(n.messageList.length-1),d:e.o(((...e)=>o.hideMorePanel&&o.hideMorePanel(...e))),e:n.inputFocus,f:e.o(((...e)=>o.sendTextMessage&&o.sendTextMessage(...e))),g:e.o(((...e)=>o.onInputFocus&&o.onInputFocus(...e))),h:e.o(((...e)=>o.onInputBlur&&o.onInputBlur(...e))),i:n.inputMessage,j:e.o((e=>n.inputMessage=e.detail.value)),k:e.o(((...e)=>o.focusInput&&o.focusInput(...e))),l:n.inputMessage.trim()},n.inputMessage.trim()?{}:{m:e.p({type:"plusempty",size:"24",color:"#333333"})},{n:n.inputMessage.trim()?1:"",o:e.o((e=>n.inputMessage.trim()?o.sendTextMessage():o.toggleMorePanel())),p:n.showMorePanel&&!n.keyboardVisible},n.showMorePanel&&!n.keyboardVisible?{q:e.p({type:"image",size:"24",color:"#ffffff"}),r:e.o(((...e)=>o.chooseImage&&o.chooseImage(...e))),s:e.p({type:"location",size:"24",color:"#ffffff"}),t:e.o(((...e)=>o.chooseLocation&&o.chooseLocation(...e))),v:e.p({type:"shop",size:"24",color:"#ffffff"}),w:e.o(((...e)=>o.shareProduct&&o.shareProduct(...e))),x:e.o((()=>{}))}:{},{y:e.o(((...e)=>o.hideMorePanel&&o.hideMorePanel(...e)))})}]]);wx.createPage(i);
