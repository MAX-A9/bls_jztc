"use strict";const e=require("../../common/vendor.js"),t=require("../../mixins/device.js"),n=require("../../mixins/share.js"),i=require("../../utils/request.js"),o=require("../../apis/index.js"),s={components:{FunctionArea:()=>"../../components/function-area/index.js",SwiperBanner:()=>"../../components/swiper-banner/index.js",ContentList:()=>"../../components/content-list/index.js",ActivityArea:()=>"../../components/activity-area/index.js",TabBar:()=>"../../components/tab-bar/index.js"},mixins:[t.deviceMixin,n.shareMixin],data:()=>({tabIndex:0,currentLocation:"",isLocating:!1,menuList:[],menuLoading:!1,currentMenu:0,headerHeight:0,showFixedMenu:!1,menuTop:0,contentTop:0,showBackToTop:!1,scrollTop:0,oldScrollTop:0,showLocationGuide:!1,pageLoading:!0,refreshing:!1,logoUrl:"/static/logo.png",contentListInitialized:!1,isHomePage:!0}),onLoad(){setTimeout((()=>{this.pageLoading&&(this.pageLoading=!1,console.log("页面加载超时，强制显示页面"))}),3e3),this.initLocation(),this.staggeredLoading()},mounted(){this.calculateHeaderHeight(),setTimeout((()=>{this.getMenuPosition()}),300)},onReady(){this.getMenuPosition()},onResize(){this.calculateHeaderHeight(),this.getMenuPosition()},onShow(){this.tabIndex=0;const t=e.index.getStorageSync("currentLocation");t&&(this.currentLocation=t,console.log("页面显示时更新位置信息:",t)),this.$nextTick((()=>{this.$refs.contentList&&!this.contentListInitialized?(console.log("页面显示时，初始化内容列表组件"),this.$refs.contentList.init(),this.contentListInitialized=!0):this.$refs.contentList&&console.log("内容列表已初始化，使用已有数据")}));!e.index.getStorageSync("notFirstLaunch")&&(e.index.setStorageSync("notFirstLaunch",!0),setTimeout((()=>{this.showLocationGuide=!0}),1e3)),this.showShareMenu()},onNavigationBarButtonTap(e){0===e.index&&this.navigateToLocationSelect()},methods:{staggeredLoading(){setTimeout((()=>{this.fetchMenuCategories()}),200),setTimeout((()=>{this.fetchBaseSettings()}),800),setTimeout((()=>{this.initVisibleComponents()}),1500)},initVisibleComponents(){this.$refs.functionArea&&this.$refs.functionArea.loadMiniProgramList(),setTimeout((()=>{this.$refs.swiperBanner&&this.$refs.swiperBanner.fetchBannerData()}),300),setTimeout((()=>{this.$refs.activityArea&&this.$refs.activityArea.fetchActivityData()}),600)},fetchMenuCategories(){this.menuLoading=!0;const e={id:0,name:"推荐"},t=setTimeout((()=>{this.menuLoading&&(this.useDefaultMenu(),this.menuLoading=!1,this.pageLoading=!1,console.log("获取菜单分类超时，使用默认值"))}),3e3);i.get("/wx/client/content/categories",{type:1}).then((n=>{if(clearTimeout(t),0===n.code){const t=n.data.list||[];this.menuList=[e,...t],console.log("成功获取菜单分类:",this.menuList)}else console.error("获取菜单分类失败:",n.message||"未知错误"),this.useDefaultMenu()})).catch((e=>{clearTimeout(t),console.error("请求菜单分类接口出错:",e),this.useDefaultMenu()})).finally((()=>{clearTimeout(t),this.menuLoading=!1,this.pageLoading=!1}))},useDefaultMenu(){this.menuList=[]},initLocation(){const t=e.index.getStorageSync("currentLocation");if(t){this.currentLocation=t,console.log("使用本地存储的位置信息:",t);const n=e.index.getStorageSync("currentLocationId");n&&(console.log("使用已保存的地区ID:",n),e.index.$emit("locationChanged",{regionId:n}),this.$nextTick((()=>{this.$refs.contentList&&!this.contentListInitialized&&(console.log("位置初始化后，调用内容列表初始化方法"),this.$refs.contentList.init(),this.contentListInitialized=!0)})))}else this.useDefaultLocation()},useDefaultLocation(){const t=e.index.getStorageSync("currentLocation");if(t){this.currentLocation=t,console.log("使用已保存的位置:",t);const n=e.index.getStorageSync("currentLocationId");return void(n&&(console.log("使用已保存的地区ID:",n),e.index.$emit("locationChanged",{regionId:n}),this.$nextTick((()=>{this.$refs.contentList&&!this.contentListInitialized&&(console.log("使用已保存位置后，调用内容列表初始化方法"),this.$refs.contentList.init(),this.contentListInitialized=!0)}))))}const n=this.$store;if(n&&n.state.region&&n.state.region.regionList.length>0){const t=n.state.region.regionList[0];this.currentLocation=t.name,console.log("从store中设置默认地区ID:",t.id),e.index.setStorageSync("currentLocationId",t.id),e.index.setStorageSync("currentLocation",t.name),e.index.$emit("locationChanged",{regionId:t.id}),this.$nextTick((()=>{this.$refs.contentList&&!this.contentListInitialized&&(console.log("设置默认位置后，调用内容列表初始化方法"),this.$refs.contentList.init(),this.contentListInitialized=!0)})),console.log("设置默认位置:",t.name,"来自",t.location)}else this.currentLocation="请选择地区",n&&n.dispatch&&n.dispatch("region/getRegionList").then((()=>{if(n.state.region.regionList.length>0){const t=n.state.region.regionList[0];this.currentLocation=t.name,e.index.setStorageSync("currentLocation",this.currentLocation),console.log("异步获取后设置地区ID:",t.id),e.index.setStorageSync("currentLocationId",t.id),e.index.$emit("locationChanged",{regionId:t.id}),this.$nextTick((()=>{this.$refs.contentList&&!this.contentListInitialized&&(console.log("异步获取位置后，调用内容列表初始化方法"),this.$refs.contentList.init(),this.contentListInitialized=!0)})),console.log("异步更新默认位置:",t.name)}})).catch((e=>{console.error("获取地区列表失败:",e)}));t||e.index.setStorageSync("currentLocation",this.currentLocation)},closeLocationGuide(){this.showLocationGuide=!1},goToLocationSelectFromGuide(){this.showLocationGuide=!1,this.navigateToLocationSelect()},navigateToLocationSelect(){e.index.navigateTo({url:"/pages/location/select/index",events:{locationSelected:t=>{t&&t.name&&(this.currentLocation=t.name,e.index.setStorageSync("currentLocation",t.name),t.id&&(console.log("位置选择数据:",t),e.index.removeStorageSync("currentLocationId"),e.index.setStorageSync("currentLocationId",t.id),this.$refs.contentList&&(console.log("直接调用内容列表组件方法更新区域ID:",t.id),this.$refs.contentList.regionId=t.id,this.$refs.contentList.resetAndLoad()),console.log("发送locationChanged事件，regionId:",t.id),e.index.$emit("locationChanged",{regionId:t.id})),console.log("用户选择了新位置:",t.name,"ID:",t.id))}}})},switchMenu(e){if(!this.menuLoading&&this.menuList.length&&this.currentMenu!==e){this.currentMenu=e;const t=this.menuList[e],n=t?t.id:"";this.$refs.contentList&&this.$refs.contentList.handleCategoryChange(n)}},calculateHeaderHeight(){e.index.createSelectorQuery().in(this).select(".fixed-header").boundingClientRect((e=>{this.headerHeight=e.height})).exec()},handleSearch(e){const t=e.detail.value;console.log("搜索关键词:",t)},getMenuPosition(){const t=e.index.createSelectorQuery().in(this);t.select(".fixed-header").boundingClientRect((e=>{e&&(this.headerHeight=e.height)})).exec(),t.select("#category-menu").boundingClientRect((e=>{e&&(this.menuTop=e.top)})).exec(),t.select("#content-area").boundingClientRect((e=>{e&&(this.contentTop=e.top-this.headerHeight,console.log("内容区域位置:",this.contentTop))})).exec()},handleScroll(e){const t=e.detail.scrollTop;this.oldScrollTop=t,this.showBackToTop=t>500,this.contentTop&&this.contentTop>0?this.showFixedMenu=t>=this.contentTop:this.showFixedMenu=t>=this.menuTop},scrollToTop(){this.scrollTop=1,this.$nextTick((()=>{this.scrollTop=0}))},handleTabChange(e){console.log("切换到标签:",e)},handlePublish(){console.log("点击发布按钮")},handleRefresh(){this.refreshing=!0,this.fetchMenuCategories(),this.$refs.functionArea&&this.$refs.functionArea.loadMiniProgramList(),this.$refs.activityArea&&this.$refs.activityArea.fetchActivityData(),this.$refs.swiperBanner&&this.$refs.swiperBanner.fetchBannerData(),this.$refs.contentList&&this.$refs.contentList.resetAndLoad(),this.initShareData(),setTimeout((()=>{this.refreshing&&(this.refreshing=!1,console.log("刷新状态超时自动关闭"))}),3e3)},handleScrollToLower(){console.log("触发上拉加载更多"),this.$refs.contentList&&this.$refs.contentList.loadMore()},fetchBaseSettings(){o.settings.getBaseSettings().then((e=>{0===e.code&&e.data?e.data.logo&&(this.logoUrl=e.data.logo,console.log("成功获取小程序Logo:",this.logoUrl)):console.error("获取小程序基础设置失败:",e.message||"未知错误")})).catch((e=>{console.error("请求小程序基础设置接口出错:",e)}))},showShareMenu(){this.initShareData(),e.index.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]})}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("function-area")+e.resolveComponent("activity-area")+e.resolveComponent("swiper-banner")+e.resolveComponent("content-list")+e.resolveComponent("tab-bar"))()}Math;const a=e._export_sfc(s,[["render",function(t,n,i,o,s,a){return e.e({a:s.pageLoading},s.pageLoading?{b:e.f(4,((e,t,n)=>({a:e})))}:{},{c:s.logoUrl,d:t.isIOS?"28px":"32px",e:e.t(s.currentLocation||"定位中..."),f:e.p({type:"bottom",size:"12",color:"#ffffff"}),g:e.o(((...e)=>a.navigateToLocationSelect&&a.navigateToLocationSelect(...e))),h:t.navBarHeight+"px",i:t.statusBarHeight+"px",j:e.p({type:"search",size:"16",color:"#666666"}),k:e.o(((...e)=>a.handleSearch&&a.handleSearch(...e))),l:!s.showFixedMenu,m:e.f(s.menuList,((t,n,i)=>({a:e.t(t.name),b:n,c:s.currentMenu===n?1:"",d:e.o((e=>a.switchMenu(n)),n)}))),n:s.menuLoading},(s.menuLoading,{}),{o:s.showFixedMenu?1:"",p:s.showFixedMenu,q:e.sr("functionArea","6d276527-2"),r:e.sr("activityArea","6d276527-3"),s:e.sr("swiperBanner","6d276527-4"),t:e.f(s.menuList,((t,n,i)=>({a:e.t(t.name),b:n,c:s.currentMenu===n?1:"",d:e.o((e=>a.switchMenu(n)),n)}))),v:s.menuLoading},(s.menuLoading,{}),{w:e.sr("contentList","6d276527-5"),x:s.headerHeight+"px",y:e.o(((...e)=>a.handleScroll&&a.handleScroll(...e))),z:s.scrollTop,A:e.o(((...e)=>a.handleScrollToLower&&a.handleScrollToLower(...e))),B:e.o(((...e)=>a.handleRefresh&&a.handleRefresh(...e))),C:s.refreshing,D:e.p({type:"top",size:"24",color:"#ffffff"}),E:s.showBackToTop,F:e.o(((...e)=>a.scrollToTop&&a.scrollToTop(...e))),G:e.o(a.handleTabChange),H:e.o(a.handlePublish),I:s.showLocationGuide},s.showLocationGuide?{J:e.t(s.currentLocation),K:e.o(((...e)=>a.goToLocationSelectFromGuide&&a.goToLocationSelectFromGuide(...e))),L:e.o((()=>{})),M:e.o(((...e)=>a.closeLocationGuide&&a.closeLocationGuide(...e)))}:{})}]]);wx.createPage(a);
