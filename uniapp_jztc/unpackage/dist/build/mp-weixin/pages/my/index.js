"use strict";const e=require("../../common/vendor.js"),o=require("../../mixins/device.js"),t=require("../../apis/content.js"),i=require("../../apis/user.js"),s=require("../../apis/index.js"),n=require("../../utils/device-info.js"),a={components:{TabBar:()=>"../../components/tab-bar/index.js"},mixins:[o.deviceMixin],data:()=>({tabIndex:4,statusBarHeight:0,navBarHeight:44,showQrCodePopup:!1,favoriteCount:0,browseHistoryCount:0,followingCount:0,publishCount:0,butlerImageUrl:""}),computed:{userInfo(){return this.$store.getters["user/userInfo"]},hasLogin(){return this.$store.getters["user/isLoggedIn"]},loginLoading(){return this.$store.state.user.loginLoading}},onLoad(){this.statusBarHeight=n.deviceInfo.getStatusBarHeight(),this.loadFavoriteData()},onShow(){this.tabIndex=4,this.checkAndRefreshUserInfo(),this.getFavoriteCount(),this.getBrowseHistoryCount(),this.getFollowingCount(),this.getPublishCount()},methods:{async handleLogin(){try{e.index.showLoading({title:"登录中",mask:!0});const o={code:await i.getWxLoginCode()},t=await i.wxappLogin(o);t&&0===t.code&&t.data&&t.data.token?(this.$store.commit("user/SET_TOKEN",t.data.token),await this.$store.dispatch("user/getUserInfo"),e.index.hideLoading(),e.index.showToast({title:"登录成功",icon:"success"}),this.getFavoriteCount(),this.getBrowseHistoryCount(),this.getFollowingCount()):(e.index.hideLoading(),e.index.showToast({title:t.message||"登录失败",icon:"none",duration:2e3}))}catch(o){e.index.hideLoading(),console.error("登录错误:",o),e.index.showToast({title:o.message||"登录失败，请重试",icon:"none",duration:2e3})}},handleUserInfoClick(){this.hasLogin?this.userInfo.phone||e.index.showToast({title:"该功能暂未开放",icon:"none"}):this.handleLogin()},async checkAndRefreshUserInfo(){if(!this.$store.getters["user/isLoggedIn"])return;const e=this.$store.getters["user/userInfo"];if(!(e&&(e.clientId||e.id))||!e.realName)try{await this.$store.dispatch("user/getUserInfo")}catch(o){if(401===o.code)try{await this.$store.dispatch("user/silentLogin")}catch(t){}}},handleSetting(){e.index.navigateTo({url:"/pages/settings/index"})},handleFeatureClick(o){if(!this.hasLogin)return void e.index.showToast({title:"请先登录",icon:"none"});const t={publish:"/pages/my/publish/index",follow:"/pages/my/follow/index",favorite:"/pages/my/favorite/index",history:"/pages/my/history/index"};t[o]?e.index.navigateTo({url:t[o]}):e.index.showToast({title:"功能开发中",icon:"none"})},handleSignIn(){this.hasLogin?e.index.navigateTo({url:"/pages/vip/music/index"}):e.index.showToast({title:"请先登录",icon:"none"})},handleViewAllOrders(){this.hasLogin?e.index.navigateTo({url:"/pages/my/orders/index"}):e.index.showToast({title:"请先登录",icon:"none"})},handleOrderType(o){if(!this.hasLogin)return void e.index.showToast({title:"请先登录",icon:"none"});let t=0;switch(o){case"processing":t=1;break;case"unpaid":t=2;break;case"completed":t=3;break;default:t=0}e.index.navigateTo({url:`/pages/my/orders/index?tab=${t}`})},showQrCode(){this.showQrCodePopup=!0,this.getButlerImage()},closeQrCode(){this.showQrCodePopup=!1},async getButlerImage(){try{const e=await i.getButlerImage();0===e.code&&e.data&&e.data.imageUrl?this.butlerImageUrl=e.data.imageUrl:console.error("获取管家二维码失败",e)}catch(e){console.error("获取管家二维码出错",e)}},handleMasterJoin(){this.hasLogin?e.index.navigateTo({url:"/pages/master/join/index"}):e.index.showToast({title:"请先登录",icon:"none"})},handleContact(){e.wx$1.openCustomerServiceChat?e.wx$1.openCustomerServiceChat({extInfo:{url:"https://work.weixin.qq.com/"},corpId:"ww5823288888ed1111",success(e){console.log("客服会话打开成功",e)},fail(o){console.error("客服会话打开失败",o),e.index.showModal({title:"在线客服",content:"无法连接客服，您可以通过右上角胶囊按钮 -> 关于 -> 客服来联系我们",confirmText:"我知道了",showCancel:!1})}}):e.index.showModal({title:"在线客服",content:"您可以通过右上角胶囊按钮 -> 关于 -> 客服来联系我们",confirmText:"我知道了",showCancel:!1})},handleFeedback(){"function"==typeof e.wx$1.showFeedback?e.wx$1.showFeedback():e.index.showModal({title:"意见反馈",content:'您可以通过"右上角胶囊按钮 -> 关于 -> 反馈与投诉"来提交反馈',confirmText:"我知道了",showCancel:!1})},async getFavoriteCount(){if(this.hasLogin)try{const e=await t.getFavoriteCount();0===e.code&&e.data?this.favoriteCount=e.data.total||0:this.favoriteCount=0}catch(e){console.error("获取收藏数量失败",e),this.favoriteCount=0}else this.favoriteCount=0},async getBrowseHistoryCount(){if(this.hasLogin)try{const e=await t.getBrowseHistoryCount();0===e.code&&e.data?this.browseHistoryCount=e.data.count||0:this.browseHistoryCount=0}catch(e){console.error("获取浏览记录数量失败",e),this.browseHistoryCount=0}else this.browseHistoryCount=0},async getFollowingCount(){if(this.hasLogin)try{const e=await t.getFollowingCount();0===e.code&&e.data?this.followingCount=e.data.count||0:this.followingCount=0}catch(e){console.error("获取关注数量失败",e),this.followingCount=0}else this.followingCount=0},async getPublishCount(){if(this.hasLogin)try{const e=await s.publish.getPublishCount();0===e.code&&e.data?this.publishCount=e.data.total||0:this.publishCount=0}catch(e){console.error("获取发布数量失败",e),this.publishCount=0}else this.publishCount=0},loadFavoriteData(){}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("tab-bar"))()}Math;const r=e._export_sfc(a,[["render",function(o,t,i,s,n,a){return e.e({a:n.statusBarHeight+"px",b:e.p({type:"gear",size:"24",color:"#ffffff"}),c:e.o(((...e)=>a.handleSetting&&a.handleSetting(...e))),d:n.navBarHeight+"px",e:a.userInfo.avatarUrl||"/static/demo/0.png",f:e.t(a.userInfo.realName||a.userInfo.nickName||"未登录"),g:e.t(a.userInfo.phone||(a.hasLogin?"绑定手机号":"点击登录")),h:e.o(((...e)=>a.handleUserInfoClick&&a.handleUserInfoClick(...e))),i:e.p({type:a.hasLogin?"gift":"person",size:"16",color:"#ffffff"}),j:e.t(a.hasLogin?"签到领福利":"立即登录"),k:e.o((e=>a.hasLogin?a.handleSignIn():a.handleLogin())),l:e.t(n.publishCount),m:e.o((e=>a.handleFeatureClick("publish"))),n:e.t(n.followingCount),o:e.o((e=>a.handleFeatureClick("follow"))),p:e.t(n.favoriteCount),q:e.o((e=>a.handleFeatureClick("favorite"))),r:e.t(n.browseHistoryCount),s:e.o((e=>a.handleFeatureClick("history"))),t:e.p({type:"right",size:"14",color:"#999999"}),v:e.o(((...e)=>a.handleViewAllOrders&&a.handleViewAllOrders(...e))),w:e.p({type:"refresh",size:"28",color:"#fc3e2b"}),x:e.o((e=>a.handleOrderType("processing"))),y:e.p({type:"wallet",size:"28",color:"#fc3e2b"}),z:e.o((e=>a.handleOrderType("unpaid"))),A:e.p({type:"checkbox-filled",size:"28",color:"#fc3e2b"}),B:e.o((e=>a.handleOrderType("completed"))),C:e.p({type:"list",size:"28",color:"#fc3e2b"}),D:e.o((e=>a.handleOrderType("all"))),E:e.p({type:"right",size:"16",color:"#999999"}),F:e.o(((...e)=>a.showQrCode&&a.showQrCode(...e))),G:e.p({type:"shop",size:"28",color:"#fc3e2b"}),H:e.p({type:"headphones",size:"28",color:"#fc3e2b"}),I:e.o(((...e)=>a.handleContact&&a.handleContact(...e))),J:e.p({type:"help",size:"28",color:"#fc3e2b"}),K:e.p({type:"chat",size:"28",color:"#fc3e2b"}),L:e.o(((...e)=>a.handleFeedback&&a.handleFeedback(...e))),M:e.p({"current-tab":n.tabIndex}),N:n.showQrCodePopup},n.showQrCodePopup?{O:n.butlerImageUrl||"/static/images/qrcode.png",P:e.p({type:"closeempty",size:"24",color:"#666666"}),Q:e.o(((...e)=>a.closeQrCode&&a.closeQrCode(...e))),R:e.o((()=>{})),S:e.o(((...e)=>a.closeQrCode&&a.closeQrCode(...e)))}:{})}]]);wx.createPage(r);
