"use strict";const e=require("../../../common/vendor.js"),t=require("../../../mixins/device.js"),s=require("../../../apis/index.js"),i=require("../../../utils/pay.js"),a=require("../../../common/assets.js"),r={mixins:[t.deviceMixin],data:()=>({currentTab:0,isRefreshing:!1,isLoading:!1,hasMore:!0,page:1,pageSize:10,total:0,tabList:[{name:"全部",status:"all"},{name:"进行中",status:"process"},{name:"待支付",status:"unpaid"},{name:"已完成",status:"completed"}],orderList:[]}),onLoad(e){e.tab&&(this.currentTab=parseInt(e.tab)),this.loadOrderList()},methods:{async loadOrderList(t=!1){if(this.isLoading)return;let i=!1;try{this.isLoading=!0,t||(e.index.showLoading({title:"加载中...",mask:!0}),i=!0),t&&(this.page=1,this.orderList=[]);const a=this.tabList[this.currentTab].status,r=await s.user.getOrderList({page:this.page,pageSize:this.pageSize,status:a});if(i&&(e.index.hideLoading(),i=!1),0!==r.code||!r.data)throw new Error(r.message||"获取订单列表失败");1===this.page?this.orderList=r.data.list||[]:this.orderList=[...this.orderList,...r.data.list||[]],this.total=r.data.total||0,this.hasMore=this.orderList.length<this.total}catch(a){i&&(e.index.hideLoading(),i=!1),console.error("获取订单列表失败:",a),e.index.showToast({title:"获取订单失败",icon:"none"})}finally{this.isLoading=!1,this.isRefreshing&&(this.isRefreshing=!1),i&&e.index.hideLoading()}},getStatusClass(e){switch(e){case 0:return"unpaid";case 1:return"processing";case 2:return"completed";case 3:return"cancelled";case 4:return"refunded";default:return""}},handleBack(){getCurrentPages().length>1?e.index.navigateBack():e.index.switchTab({url:"/pages/my/index"})},switchTab(e){this.currentTab!==e&&(this.currentTab=e,this.page=1,this.hasMore=!0,this.loadOrderList(!0))},onRefresh(){this.isRefreshing=!0,this.page=1,this.hasMore=!0,this.loadOrderList(!0)},loadMore(){this.hasMore&&!this.isLoading&&(this.page++,this.loadOrderList())},handleOrderClick(t){e.index.navigateTo({url:`/pages/my/orders/detail?orderNo=${t.orderNo}`})},handleContactService(t){e.index.makePhoneCall({phoneNumber:"10086",fail:()=>{e.index.showToast({title:"拨打电话失败",icon:"none"})}})},handleCancelOrder(t){e.index.showModal({title:"提示",content:"确定要取消该订单吗？",success:async i=>{if(i.confirm){let i=!1;try{e.index.showLoading({title:"处理中...",mask:!0}),i=!0,await s.user.cancelOrder({orderNo:t.orderNo,reason:"用户主动取消"}),i&&(e.index.hideLoading(),i=!1),e.index.showToast({title:"已取消订单",icon:"success"}),this.onRefresh()}catch(a){i&&(e.index.hideLoading(),i=!1),console.error("取消订单失败:",a),e.index.showToast({title:a.message||"取消失败",icon:"none"})}finally{i&&e.index.hideLoading()}}}})},async handlePayOrder(t){let s=!1;try{e.index.showLoading({title:"正在支付...",mask:!0}),s=!0;const a=await i.requestOrderPay({orderNo:t.orderNo});s&&(e.index.hideLoading(),s=!1),a.success?(e.index.showToast({title:"支付成功",icon:"success"}),this.onRefresh()):e.index.showToast({title:a.message||"支付已取消",icon:"none"})}catch(a){s&&(e.index.hideLoading(),s=!1),console.error("支付过程出错:",a),e.index.showToast({title:a.message||"支付失败",icon:"none"})}finally{s&&e.index.hideLoading()}},handleRebuyOrder(t){e.index.navigateTo({url:"/pages/publish/info/index"})}}};if(!Array){e.resolveComponent("uni-icons")()}Math;const o=e._export_sfc(r,[["render",function(t,s,i,r,o,n){return e.e({a:e.p({type:"left",size:"20",color:"#333333"}),b:e.o(((...e)=>n.handleBack&&n.handleBack(...e))),c:t.navBarHeight+"px",d:e.f(o.tabList,((t,s,i)=>({a:e.t(t.name),b:s,c:o.currentTab===s?1:"",d:e.o((e=>n.switchTab(s)),s)}))),e:t.statusBarHeight+"px",f:e.f(o.orderList,((t,s,i)=>e.e({a:e.t(t.createdAt),b:e.t(t.statusText),c:e.n(n.getStatusClass(t.status)),d:"e6418f06-1-"+i,e:e.t(t.productName),f:e.t(t.orderNo),g:e.t(t.amount.toFixed(2)),h:0===t.status},0===t.status?{i:e.o((e=>n.handleCancelOrder(t)),t.id),j:e.o((e=>n.handlePayOrder(t)),t.id)}:1===t.status?{l:e.o((e=>n.handleContactService(t)),t.id)}:2===t.status||3===t.status?{n:e.o((e=>n.handleRebuyOrder(t)),t.id)}:{},{k:1===t.status,m:2===t.status||3===t.status,o:t.id,p:e.o((e=>n.handleOrderClick(t)),t.id)}))),g:e.p({type:"shop",size:"30",color:"#fc3e2b"}),h:o.orderList.length>0&&o.hasMore},(o.orderList.length>0&&o.hasMore,{}),{i:o.orderList.length>0&&!o.hasMore},(o.orderList.length>0&&o.hasMore,{}),{j:0===o.orderList.length&&!o.isLoading},0!==o.orderList.length||o.isLoading?{}:{k:a._imports_0},{l:`calc(${t.statusBarHeight}px + ${t.navBarHeight}px + 80rpx)`,m:o.isRefreshing,n:e.o(((...e)=>n.onRefresh&&n.onRefresh(...e))),o:e.o(((...e)=>n.loadMore&&n.loadMore(...e)))})}]]);wx.createPage(o);
