"use strict";const t=require("../../../common/vendor.js"),e=require("../../../apis/content.js"),i=require("../../../common/assets.js"),s={data:()=>({currentFilter:0,isRefreshing:!1,dateFilters:["全部","今天","昨天","本周","本月"],timeTypeMap:{0:"all",1:"today",2:"yesterday",3:"this_week",4:"this_month"},historyList:[],page:1,pageSize:10,hasMore:!0,loading:!1,total:0}),created(){this.loadBrowseHistory()},computed:{groupedHistory(){const t={};return this.historyList.forEach((e=>{const i=e.browseTime.split(" ")[0];t[i]||(t[i]=[]),t[i].push(e)})),t}},methods:{switchFilter(t){this.currentFilter!==t&&(this.currentFilter=t,this.page=1,this.historyList=[],this.hasMore=!0,this.loadBrowseHistory())},async loadBrowseHistory(){if(!this.loading)try{this.loading=!0;const t={timeType:this.timeTypeMap[this.currentFilter],page:this.page,pageSize:this.pageSize},i=await e.getBrowseHistoryList(t);if(0!==i.code||!i.data)throw new Error(i.message||"获取浏览历史失败");{const{list:t=[],total:e=0,page:s=1}=i.data,o=t.map((t=>({id:t.id,contentId:t.contentId,title:t.contentTitle||"未知标题",image:t.contentCover||"",price:t.price||0,contentType:t.contentType,browseTime:t.browseTime,time:t.browseTime.split(" ")[1],category:t.category||"未分类",contentStatus:t.contentStatus})));1===this.page?this.historyList=o:this.historyList=[...this.historyList,...o],this.total=e,this.hasMore=this.historyList.length<e,this.page++}}catch(i){console.error("加载浏览历史失败:",i),t.index.showToast({title:"加载失败，请重试",icon:"none",duration:2e3})}finally{this.loading=!1,this.isRefreshing&&(this.isRefreshing=!1)}},async onRefresh(){this.isRefreshing=!0,this.page=1,this.hasMore=!0,await this.loadBrowseHistory(),t.index.showToast({title:"刷新成功",icon:"success"})},handleItemClick(e){if(0===e.contentStatus||2===e.contentStatus)return void t.index.showToast({title:"该内容已下架",icon:"none",duration:2e3});let i="";if("idle"===e.contentType)i=`/pages/community/detail?id=${e.contentId}`;else i=`/pages/content/detail?id=${e.contentId}`;t.index.navigateTo({url:i})},async handleClearHistory(){t.index.showModal({title:"提示",content:"确定要清空浏览记录吗？",success:async i=>{if(i.confirm)try{const i=this.timeTypeMap[this.currentFilter],s=await e.clearBrowseHistory(i);if(0!==s.code)throw new Error(s.message||"清空失败");this.historyList=[],this.page=1,this.hasMore=!1,t.index.showToast({title:"已清空记录",icon:"success"})}catch(s){console.error("清空浏览记录失败:",s),t.index.showToast({title:"清空失败，请重试",icon:"none"})}}})},handleExplore(){t.index.switchTab({url:"/pages/index/index"})},loadMore(){this.hasMore&&!this.loading&&this.loadBrowseHistory()},handleImageError(t){t.image=""}}};if(!Array){t.resolveComponent("uni-icons")()}Math;const o=t._export_sfc(s,[["render",function(e,s,o,n,r,a){return t.e({a:t.f(r.dateFilters,((e,i,s)=>({a:t.t(e),b:i,c:r.currentFilter===i?1:"",d:t.o((t=>a.switchFilter(i)),i)}))),b:t.p({type:"trash",size:"16",color:"#666666"}),c:t.t(r.currentFilter>0?r.dateFilters[r.currentFilter]:"全部"),d:t.o(((...t)=>a.handleClearHistory&&a.handleClearHistory(...t))),e:r.loading&&0===r.historyList.length},(r.loading&&r.historyList.length,{}),{f:r.historyList.length>0},r.historyList.length>0?t.e({g:t.f(a.groupedHistory,((e,i,s)=>({a:t.t(i),b:t.f(e,((e,i,s)=>t.e({a:0===e.contentStatus||2===e.contentStatus},(0===e.contentStatus||e.contentStatus,{}),{b:e.image},e.image?{c:e.image,d:t.o((t=>a.handleImageError(e)),i)}:{},{e:t.t(e.title),f:0===e.contentStatus||2===e.contentStatus?1:"",g:e.price>0},e.price>0?{h:t.t(e.price)}:{},{i:t.t(e.time),j:t.t(e.category),k:0===e.contentStatus||2===e.contentStatus},(0===e.contentStatus||e.contentStatus,{}),{l:0===e.contentStatus||2===e.contentStatus?1:"",m:e.image?"":1,n:i,o:t.o((t=>a.handleItemClick(e)),i),p:0===e.contentStatus||2===e.contentStatus?1:""}))),c:i}))),h:r.historyList.length>0},r.historyList.length>0?t.e({i:r.loading&&r.historyList.length>0},(r.loading&&r.historyList.length>0||r.hasMore,{}),{j:r.hasMore}):{}):{},{k:!r.loading&&0===r.historyList.length},r.loading||0!==r.historyList.length?{}:{l:i._imports_0$2,m:t.o(((...t)=>a.handleExplore&&a.handleExplore(...t)))},{n:r.isRefreshing,o:t.o(((...t)=>a.onRefresh&&a.onRefresh(...t))),p:t.o(((...t)=>a.loadMore&&a.loadMore(...t)))})}]]);wx.createPage(o);
