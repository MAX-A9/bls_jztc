"use strict";const e=require("../../../common/vendor.js"),t=require("../../../mixins/device.js"),i=require("../../../apis/content.js"),o=require("../../../utils/constants.js"),a=require("../../../utils/auth.js"),n=require("../../../utils/storage.js"),s=require("../../../utils/device-info.js"),r={mixins:[t.deviceMixin],data:()=>({statusBarHeight:0,navBarHeight:44,images:[],loading:!1,formData:{type:"",title:"",description:"",price:"",originalPrice:"",location:"同城交易",latitude:void 0,longitude:void 0,contact:{name:"",phone:"",wechat:""}},idleTypes:[]}),computed:{...e.mapState("region",["regionList"])},onLoad(t){if(!a.isLoggedIn())return e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.navigateTo({url:"/pages/login/index"})}),1500);this.statusBarHeight=s.deviceInfo.getStatusBarHeight(),this.ensureRegionDataLoaded(),this.loadIdleCategories(),t.draftId&&this.loadDraftData(t.draftId)},methods:{handleBack(){e.index.navigateBack()},async loadIdleCategories(){if(!this.loading){this.loading=!0;try{e.index.showLoading({title:"加载中...",mask:!0});const t=await i.getInfoCategories(2);if(console.log("闲置分类数据:",t),0!==t.code||!t.data||!t.data.list)throw new Error("获取分类失败");this.idleTypes=t.data.list.map((e=>({label:e.name,value:e.id.toString(),iconUrl:e.icon,id:e.id}))),this.idleTypes.length>0&&(this.formData.type=this.idleTypes[0].value)}catch(t){console.error("加载闲置分类失败:",t),this.useDefaultCategories(),e.index.showToast({title:"加载分类失败，使用默认分类",icon:"none"})}finally{this.loading=!1,e.index.hideLoading()}}},useDefaultCategories(){this.idleTypes=[],this.formData.type="",e.index.showToast({title:"分类加载失败，请刷新重试",icon:"none",duration:2e3})},async chooseImage(){try{const i=await new Promise(((t,i)=>{e.index.chooseImage({count:9-this.images.length,sizeType:["compressed"],sourceType:["album","camera"],success:t,fail:i})}));if(i.tempFilePaths&&i.tempFilePaths.length>0){e.index.showLoading({title:"上传中...",mask:!0});try{const t=i.tempFilePaths.map((async e=>{try{return await this.uploadFile(e)}catch(t){return console.error("上传图片失败:",t),null}})),o=(await Promise.all(t)).filter((e=>null!==e));this.images=[...this.images,...o]}catch(t){console.error("处理上传图片时出错:",t),e.index.showToast({title:"上传图片失败",icon:"none"})}finally{e.index.hideLoading()}}}catch(t){console.error("选择图片失败:",t),e.index.showToast({title:"选择图片失败",icon:"none"}),this.loading&&e.index.hideLoading()}},uploadFile:async t=>new Promise(((i,a)=>{const n=e.index.getStorageSync("token");if(!n)return e.index.showToast({title:"请先登录",icon:"none"}),a(new Error("请先登录"));e.index.uploadFile({url:o.API_BASE_URL+"/wx/upload/image",filePath:t,name:"file",header:{Authorization:"Bearer "+n},success:e=>{try{const t=JSON.parse(e.data);console.log("上传响应:",t),0===t.code&&t.data?i(t.data.url):a(new Error(t.message||"上传失败"))}catch(t){console.error("解析上传响应失败:",t),a(t)}},fail:e=>{console.error("上传请求失败:",e),a(e)}})})),deleteImage(e){this.images.splice(e,1)},showLocationPicker(){e.index.choosePoi({success:e=>{if(console.log("选择位置成功:",e),1===e.type){let t=e.city||"";t.indexOf("省")>0?t=t.split("省")[1]:t.indexOf("自治区")>0&&(t=t.split("自治区")[1]),this.formData.location=t,this.formData.latitude=void 0,this.formData.longitude=void 0}else if(2===e.type){let t=e.address||"",i=e.name||"",o="";t.indexOf("省")>0?t=t.split("省")[1]:t.indexOf("自治区")>0&&(t=t.split("自治区")[1]),o=(t.indexOf("市"),t+" "+i),this.formData.location=o,this.formData.latitude=e.latitude,this.formData.longitude=e.longitude}},fail:t=>{console.error("选择位置失败:",t),t.errMsg&&-1!==t.errMsg.indexOf("cancel")||e.index.showToast({title:"位置选择失败，请重试",icon:"none"})}})},selectIdleType(e){this.formData.type=e},saveDraft(){if(this.formData.title||this.formData.description)try{const t={...this.formData,images:this.images};if(!n.saveIdleDraft(t))throw new Error("保存失败");e.index.showToast({title:"草稿保存成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(t){console.error("保存草稿失败",t),e.index.showToast({title:"保存草稿失败",icon:"none"})}else e.index.showToast({title:"请填写标题或描述",icon:"none"})},async publishItem(){if(!a.isLoggedIn())return void e.index.showToast({title:"请先登录",icon:"none"});if(!this.validateForm(!0))return;let t=!1;try{e.index.showLoading({title:"正在发布...",mask:!0}),t=!0;let o="";this.formData.description.split("\n").filter((e=>e.trim())).forEach((e=>{o+=`<p>${e}</p>`})),this.images.length>0&&this.images.forEach((e=>{o+=`<p><img src="${e}"></p>`}));const a={categoryId:this.formData.type?parseInt(this.formData.type):0,title:this.formData.title,price:parseFloat(this.formData.price)||0,originalPrice:parseFloat(this.formData.originalPrice)||0,content:o,tradeMethod:"线下交易",tradePlace:this.formData.location||"同城交易",images:this.images,regionId:this.getRegionId()};console.log("提交数据:",a);const n=await i.createIdle(a);if(t&&(e.index.hideLoading(),t=!1),0!==n.code)throw new Error(n.message||"发布失败");e.index.showToast({title:"发布成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(o){t&&(e.index.hideLoading(),t=!1),console.error("发布闲置失败:",o),e.index.showToast({title:o.message||"发布失败，请重试",icon:"none"})}finally{t&&e.index.hideLoading()}},validatePriceInput(t){const i=this.formData[t];if(!i)return;if(!/^\d+(\.\d{0,2})?$/.test(i)){const o=/[^\d.]/.test(i),a=i.replace(/[^\d.]/g,"").replace(/\.{2,}/g,".").replace(/^(\d+\.\d{0,2}).*$/,"$1");this.formData[t]=a,o&&e.index.showToast({title:"请只输入数字和小数点",icon:"none",duration:1500})}},validateForm(t){if(!this.formData.type)return e.index.showToast({title:"请选择闲置类型",icon:"none"}),!1;if(0===this.images.length)return e.index.showToast({title:"请至少上传一张图片",icon:"none"}),!1;if(!this.formData.title.trim())return e.index.showToast({title:"请填写商品标题",icon:"none"}),!1;if(t){if(!this.formData.price)return e.index.showToast({title:"请填写商品价格",icon:"none"}),!1;const t=/^\d+(\.\d{1,2})?$/;if(!t.test(this.formData.price))return e.index.showToast({title:"请输入正确的价格格式",icon:"none"}),!1;if(void 0!==this.formData.originalPrice&&""!==this.formData.originalPrice){if(!t.test(this.formData.originalPrice))return e.index.showToast({title:"请输入正确的原价格式",icon:"none"}),!1;if(/[^\d.]/.test(this.formData.originalPrice))return e.index.showToast({title:"原价只能输入数字",icon:"none"}),!1}if(!this.formData.location)return e.index.showToast({title:"请选择交易地点",icon:"none"}),!1}return!0},ensureRegionDataLoaded(){!this.$store||!this.$store.state.region||this.$store.state.region.regionList&&0!==this.$store.state.region.regionList.length||this.$store.dispatch("region/getRegionList").catch((e=>{console.error("加载地区数据失败:",e)}))},getRegionId(){let t=0;const i=e.index.getStorageSync("currentLocation");if(this.regionList&&this.regionList.length>0){const e=this.regionList.find((e=>e.name===i));e?(t=e.id,console.log("找到当前地区ID:",t,"地区名称:",i)):console.log("未找到当前地区ID，使用默认ID 0, 当前地区名称:",i)}return t},loadDraftData(t){try{const i=n.getIdleDraft(Number(t));if(!i)return void e.index.showToast({title:"草稿不存在",icon:"none"});i.type&&(this.formData.type=i.type),i.title&&(this.formData.title=i.title),i.description&&(this.formData.description=i.description),i.price&&(this.formData.price=i.price),i.originalPrice&&(this.formData.originalPrice=i.originalPrice),i.location&&(this.formData.location=i.location),i.latitude&&(this.formData.latitude=i.latitude),i.longitude&&(this.formData.longitude=i.longitude),i.contact&&(this.formData.contact=i.contact),i.images&&i.images.length>0&&(this.images=i.images)}catch(i){console.error("加载草稿失败",i),e.index.showToast({title:"加载草稿失败",icon:"none"})}}}};if(!Array){e.resolveComponent("uni-icons")()}Math;const l=e._export_sfc(r,[["render",function(t,i,o,a,n,s){return e.e({a:e.p({type:"left",size:"20",color:"#333333"}),b:e.o(((...e)=>s.handleBack&&s.handleBack(...e))),c:n.navBarHeight+"px",d:n.statusBarHeight+"px",e:`calc(${n.statusBarHeight}px + ${n.navBarHeight}px)`,f:e.f(n.idleTypes,((t,i,o)=>e.e({a:t.iconUrl},t.iconUrl?{b:t.iconUrl}:{c:"c1ab8c16-1-"+o,d:e.p({type:"info",size:"24",color:n.formData.type===t.value?"#ffffff":"#666666"})},{e:e.t(t.label),f:i,g:n.formData.type===t.value?1:"",h:e.o((e=>s.selectIdleType(t.value)),i)}))),g:n.formData.title,h:e.o((e=>n.formData.title=e.detail.value)),i:e.t(n.formData.title.length),j:n.formData.description,k:e.o((e=>n.formData.description=e.detail.value)),l:e.t(n.formData.description.length),m:e.f(n.images,((t,i,o)=>({a:t,b:"c1ab8c16-2-"+o,c:e.o((e=>s.deleteImage(i)),i),d:i}))),n:e.p({type:"closeempty",size:"14",color:"#ffffff"}),o:n.images.length<9},n.images.length<9?{p:e.p({type:"camera",size:"24",color:"#999999"}),q:e.t(n.images.length),r:e.o(((...e)=>s.chooseImage&&s.chooseImage(...e)))}:{},{s:e.o([e=>n.formData.price=e.detail.value,e=>s.validatePriceInput("price")]),t:n.formData.price,v:e.o([e=>n.formData.originalPrice=e.detail.value,e=>s.validatePriceInput("originalPrice")]),w:n.formData.originalPrice,x:e.t(n.formData.location||"请选择交易地点"),y:e.p({type:"right",size:"16",color:"#999999"}),z:e.o(((...e)=>s.showLocationPicker&&s.showLocationPicker(...e))),A:e.o(((...e)=>s.saveDraft&&s.saveDraft(...e))),B:e.o(((...e)=>s.publishItem&&s.publishItem(...e)))})}]]);wx.createPage(l);
