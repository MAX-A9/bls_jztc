"use strict";const e=require("../../../common/vendor.js"),t=require("../../../mixins/device.js"),i=require("../../../apis/content.js"),a=require("../../../utils/constants.js"),o=require("../../../utils/auth.js"),s=require("../../../utils/pay.js"),n=require("../../../utils/storage.js"),r=require("../../../utils/device-info.js"),d={mixins:[t.deviceMixin],data:()=>({statusBarHeight:0,navBarHeight:44,images:[],loading:!1,formData:{type:"",title:"",description:"",publishPackageId:null,topPackageId:null},infoTypes:[],publishPackages:[],topPackages:[]}),computed:{...e.mapState("region",["regionList"])},onLoad(t){if(!o.isLoggedIn())return e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.navigateTo({url:"/pages/login/index"})}),1500);this.statusBarHeight=r.deviceInfo.getStatusBarHeight(),this.loadCategories(),this.loadPackages(),this.ensureRegionDataLoaded(),t.draftId&&this.loadDraftData(t.draftId)},methods:{handleBack(){e.index.navigateBack()},async loadCategories(){if(!this.loading){this.loading=!0;try{e.index.showLoading({title:"加载中...",mask:!0});const t=await i.getInfoCategories(1);if(console.log("分类数据:",t),0!==t.code||!t.data||!t.data.list)throw new Error("获取分类失败");this.infoTypes=t.data.list,this.infoTypes.length>0&&(this.formData.type=this.infoTypes[0].id.toString())}catch(t){console.error("加载分类失败:",t),this.useDefaultCategories(),e.index.showToast({title:"加载分类失败，请重试",icon:"none"})}finally{this.loading=!1,e.index.hideLoading()}}},useDefaultCategories(){this.infoTypes=[],this.formData.type="",e.index.showToast({title:"分类加载失败，请刷新重试",icon:"none",duration:2e3})},handlePreview(){e.index.showToast({title:"预览功能开发中",icon:"none"})},selectInfoType(e){this.formData.type=e},async chooseImage(){try{const i=await new Promise(((t,i)=>{e.index.chooseImage({count:9-this.images.length,sizeType:["compressed"],sourceType:["album","camera"],success:t,fail:i})}));if(i.tempFilePaths&&i.tempFilePaths.length>0){e.index.showLoading({title:"上传中...",mask:!0});try{const t=i.tempFilePaths.map((async e=>{try{return await this.uploadFile(e)}catch(t){return console.error("上传图片失败:",t),null}})),a=(await Promise.all(t)).filter((e=>null!==e));this.images=[...this.images,...a]}catch(t){console.error("处理上传图片时出错:",t),e.index.showToast({title:"上传图片失败",icon:"none"})}finally{e.index.hideLoading()}}}catch(t){console.error("选择图片失败:",t),e.index.showToast({title:"选择图片失败",icon:"none"})}},uploadFile:async t=>new Promise(((i,o)=>{const s=e.index.getStorageSync("token");if(!s)return e.index.showToast({title:"请先登录",icon:"none"}),o(new Error("请先登录"));e.index.uploadFile({url:a.API_BASE_URL+"/wx/upload/image",filePath:t,name:"file",header:{Authorization:"Bearer "+s},success:e=>{try{const t=JSON.parse(e.data);console.log("上传响应:",t),0===t.code&&t.data?i(t.data.url):o(new Error(t.message||"上传失败"))}catch(t){console.error("解析上传响应失败:",t),o(t)}},fail:e=>{console.error("上传请求失败:",e),o(e)}})})),deleteImage(e){this.images.splice(e,1)},selectPublishPackage(e){this.formData.publishPackageId=e},selectTopPackage(e){this.formData.topPackageId=e},saveDraft(){if(this.formData.title||this.formData.description)try{const t={...this.formData,images:this.images};if(!n.saveInfoDraft(t))throw new Error("保存失败");e.index.showToast({title:"草稿保存成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(t){console.error("保存草稿失败",t),e.index.showToast({title:"保存草稿失败",icon:"none"})}else e.index.showToast({title:"请填写标题或描述",icon:"none"})},async publishItem(){if(!o.isLoggedIn())return e.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{e.index.navigateTo({url:"/pages/login/index"})}),1500);if(!this.validateForm())return;let t=!1;try{e.index.showLoading({title:"正在发布...",mask:!0}),t=!0;let o="";this.formData.description.split("\n").filter((e=>e.trim())).forEach((e=>{o+=`<p>${e}</p>`})),this.images.length>0&&this.images.forEach((e=>{o+=`<p><img src="${e}"></p>`}));let n=this.getRegionId();const r={categoryId:this.formData.type?parseInt(this.formData.type):0,title:this.formData.title,content:o,publishPackageId:this.formData.publishPackageId,topPackageId:this.formData.topPackageId,isTopRequest:null!==this.formData.topPackageId,topDays:0,regionId:n,images:this.images};console.log("提交数据:",r);const d=await i.createInfo(r);if(t&&(e.index.hideLoading(),t=!1),0!==d.code)throw new Error(d.message||"发布失败");{const t=d.data.orderNo;if(t){const i=this.publishPackages.find((e=>e.id===this.formData.publishPackageId)),o=this.formData.topPackageId?this.topPackages.find((e=>e.id===this.formData.topPackageId)):null,n=i?i.price:0,r=n+(o?o.price:0);if(r>0)try{const a=o?`${i.title}+${o.title}`:i.title,n=await s.requestWxPay({body:a,orderNo:t,totalFee:r});n.success?e.index.showToast({title:"支付成功",icon:"success"}):e.index.showToast({title:n.message||"支付已取消",icon:"none"})}catch(a){console.error("支付过程出错:",a),e.index.showToast({title:a.message||"支付失败",icon:"none"})}}e.index.showToast({title:"发布成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500)}}catch(n){t&&(e.index.hideLoading(),t=!1),console.error("发布信息失败:",n),e.index.showToast({title:n.message||"发布失败，请重试",icon:"none"})}finally{t&&e.index.hideLoading()}},validateForm(){return this.formData.type?this.formData.title.trim()?this.formData.description.trim()?!(this.publishPackages.length>0&&!this.formData.publishPackageId)||(e.index.showToast({title:"请选择发布套餐",icon:"none"}),!1):(e.index.showToast({title:"请填写信息描述",icon:"none"}),!1):(e.index.showToast({title:"请填写信息标题",icon:"none"}),!1):(e.index.showToast({title:"请选择信息类型",icon:"none"}),!1)},ensureRegionDataLoaded(){!this.$store||!this.$store.state.region||this.$store.state.region.regionList&&0!==this.$store.state.region.regionList.length||this.$store.dispatch("region/getRegionList").catch((e=>{console.error("加载地区数据失败:",e)}))},getRegionId(){let t=0;const i=e.index.getStorageSync("currentLocation");if(this.regionList&&this.regionList.length>0){const e=this.regionList.find((e=>e.name===i));e?(t=e.id,console.log("找到当前地区ID:",t,"地区名称:",i)):console.log("未找到当前地区ID，使用默认ID 0, 当前地区名称:",i)}return t},async loadPackages(){try{e.index.showLoading({title:"加载中...",mask:!0});const t=await i.getPackageList();if(0!==t.code||!t.data)throw new Error("获取套餐数据失败");{let e=t.data.topPackages||[],i=t.data.publishPackages||[];const a=void 0===t.data.topEnabled||t.data.topEnabled,o=void 0===t.data.publishEnabled||t.data.publishEnabled;e.length>0&&(e=e.sort(((e,t)=>e.sortOrder===t.sortOrder||void 0===e.sortOrder||void 0===t.sortOrder?e.id-t.id:e.sortOrder-t.sortOrder))),i.length>0&&(i=i.sort(((e,t)=>e.sortOrder===t.sortOrder||void 0===e.sortOrder||void 0===t.sortOrder?e.id-t.id:e.sortOrder-t.sortOrder))),this.topPackages=a?e:[],this.publishPackages=o?i:[],this.publishPackages.length>0?this.formData.publishPackageId=this.publishPackages[0].id:this.formData.publishPackageId=null,a||(this.formData.topPackageId=null)}}catch(t){console.error("加载套餐数据失败:",t),e.index.showToast({title:"加载套餐失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},loadDraftData(t){try{const i=n.getInfoDraft(Number(t));if(!i)return void e.index.showToast({title:"草稿不存在",icon:"none"});i.type&&(this.formData.type=i.type),i.title&&(this.formData.title=i.title),i.description&&(this.formData.description=i.description),i.publishPackageId&&(this.formData.publishPackageId=i.publishPackageId),i.topPackageId&&(this.formData.topPackageId=i.topPackageId),i.images&&i.images.length>0&&(this.images=i.images)}catch(i){console.error("加载草稿失败",i),e.index.showToast({title:"加载草稿失败",icon:"none"})}}}};if(!Array){e.resolveComponent("uni-icons")()}Math;const c=e._export_sfc(d,[["render",function(t,i,a,o,s,n){return e.e({a:e.p({type:"left",size:"20",color:"#333333"}),b:e.o(((...e)=>n.handleBack&&n.handleBack(...e))),c:s.navBarHeight+"px",d:s.statusBarHeight+"px",e:`calc(${s.statusBarHeight}px + ${s.navBarHeight}px)`,f:e.f(s.infoTypes,((t,i,a)=>e.e({a:t.icon},t.icon?{b:t.icon}:{c:"d9e4d362-1-"+a,d:e.p({type:"info",size:"24",color:s.formData.type===t.id.toString()?"#ffffff":"#666666"})},{e:e.t(t.name),f:i,g:s.formData.type===t.id.toString()?1:"",h:e.o((e=>n.selectInfoType(t.id.toString())),i)}))),g:s.formData.title,h:e.o((e=>s.formData.title=e.detail.value)),i:e.t(s.formData.title.length),j:s.formData.description,k:e.o((e=>s.formData.description=e.detail.value)),l:e.t(s.formData.description.length),m:e.f(s.images,((t,i,a)=>({a:t,b:"d9e4d362-2-"+a,c:e.o((e=>n.deleteImage(i)),i),d:i}))),n:e.p({type:"closeempty",size:"14",color:"#ffffff"}),o:s.images.length<9},s.images.length<9?{p:e.p({type:"camera",size:"24",color:"#999999"}),q:e.t(s.images.length),r:e.o(((...e)=>n.chooseImage&&n.chooseImage(...e)))}:{},{s:s.publishPackages.length>0},s.publishPackages.length>0?{t:e.f(s.publishPackages,((t,i,a)=>e.e({a:e.t(t.title),b:e.t(0===t.price?"免费":t.price+"元"),c:s.formData.publishPackageId===t.id},(s.formData.publishPackageId,t.id,{}),{d:s.formData.publishPackageId===t.id?1:"",e:"publish-"+t.id,f:e.o((e=>n.selectPublishPackage(t.id)),"publish-"+t.id)})))}:{},{v:s.topPackages.length>0},s.topPackages.length>0?{w:e.f(s.topPackages,((t,i,a)=>e.e({a:e.t(t.title),b:e.t(0===t.price?"免费":t.price+"元"),c:s.formData.topPackageId===t.id},(s.formData.topPackageId,t.id,{}),{d:s.formData.topPackageId===t.id?1:"",e:"top-"+t.id,f:e.o((e=>n.selectTopPackage(t.id)),"top-"+t.id)})))}:{},{x:e.o(((...e)=>n.saveDraft&&n.saveDraft(...e))),y:e.o(((...e)=>n.publishItem&&n.publishItem(...e)))})}]]);wx.createPage(c);
