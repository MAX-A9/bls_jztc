"use strict";const t=require("../../../common/vendor.js"),e=require("../../../utils/pinyin.js"),o={data:()=>({currentLocation:"",searchKeyword:"",recentLocations:[],scrollTop:0,letterPositions:{},showLetterIndicator:!1,currentLetter:"",touchStartY:0,touchStartTime:0,isTouching:!1,letterIndexRect:null}),computed:{...t.mapState("region",["regionList","loading","error"]),...t.mapGetters("region",["hotRegions"]),filteredCityList(){const t=this.$store.getters["region/groupedRegionList"];if(!this.searchKeyword)return t;const o=this.searchKeyword.toLowerCase(),n={};for(const i in t){const r=t[i].filter((t=>{if(t.name.toLowerCase().includes(o))return!0;if(e.getStringFirstLetter(t.name).toLowerCase()===o.charAt(0).toLowerCase())return!0;if(e.getPinyin(t.name,{separator:""}).toLowerCase().includes(o))return!0;return!!e.getPinyin(t.name,{pattern:"first",separator:""}).toLowerCase().includes(o)}));r.length>0&&(n[i]=r)}return n},indexLetters(){return Object.keys(this.filteredCityList).sort()}},onLoad(){const e=t.index.getStorageSync("currentLocation");e?(this.currentLocation=e,console.log("使用已保存的位置:",e)):this.currentLocation="加载中...";const o=t.index.getStorageSync("recentLocations");o&&(this.recentLocations=JSON.parse(o)),this.fetchRegionList()},onReady(){setTimeout((()=>{t.index.createSelectorQuery().in(this).select(".letter-index").boundingClientRect((t=>{this.letterIndexRect=t})).exec()}),300)},methods:{...t.mapActions("region",{getRegionList:"getRegionList"}),fetchRegionList(){this.getRegionList({status:0}),this.$nextTick((()=>{let e=!1;const o=()=>{if(this.regionList&&this.regionList.length>0&&!e){e=!0;const o=t.index.getStorageSync("currentLocation");o&&"未知地区"!==o&&"加载中..."!==o&&"请选择地区"!==o||this.regionList.length>0&&(this.currentLocation=this.regionList[0].name,t.index.setStorageSync("currentLocation",this.currentLocation),console.log("位置选择页更新默认位置:",this.currentLocation)),setTimeout((()=>{this.getLetterPositions()}),500)}};if(o(),!e){const t=setInterval((()=>{o(),!e&&this.regionList||clearInterval(t)}),500);setTimeout((()=>{clearInterval(t)}),3e4)}}))},handleSearch(t){},selectLocation(e){let o=null;this.regionList.forEach((t=>{t.name===e&&(o=t)})),o||(console.error("未找到选择的城市对象:",e),o={id:0,name:e}),console.log("选择城市:",o),t.index.setStorageSync("currentLocation",o.name),t.index.setStorageSync("currentLocationId",o.id),console.log("保存地区ID到本地存储:",o.id);let n=this.recentLocations.filter((t=>t!==o.name));n.unshift(o.name),n.length>3&&(n=n.slice(0,3)),this.recentLocations=n,t.index.setStorageSync("recentLocations",JSON.stringify(n));const i=this.getOpenerEventChannel();i&&i.emit?(i.emit("locationSelected",{id:o.id,name:o.name}),console.log("通过事件通道发送地区信息:",o.id,o.name)):console.error("无法获取事件通道"),t.index.navigateBack(),t.index.showToast({title:"已切换到"+o.name,icon:"success"})},getLetterPositions(){const e=t.index.createSelectorQuery().in(this);this.indexLetters.forEach((t=>{e.select("#letter-"+t).boundingClientRect()})),e.select(".content-scroll").boundingClientRect(),e.exec((t=>{if(t&&t.length>0){const e=t[t.length-1];this.letterPositions={};for(let o=0;o<this.indexLetters.length;o++){const n=this.indexLetters[o],i=t[o];i&&(this.letterPositions[n]=i.top-e.top)}}}))},scrollToLetter(e){if(this.letterPositions&&void 0!==this.letterPositions[e])return this.scrollTop=this.letterPositions[e],void(t.index.vibrateShort&&t.index.vibrateShort());t.index.createSelectorQuery().in(this).select("#letter-"+e).boundingClientRect((e=>{if(e){t.index.createSelectorQuery().in(this).select(".content-scroll").boundingClientRect((o=>{if(o){const n=e.top-o.top;this.scrollTop=n,t.index.vibrateShort&&t.index.vibrateShort()}})).exec()}})).exec()},handleTouchStart(t){this.touchStartY=t.touches[0].clientY,this.touchStartTime=Date.now(),this.isTouching=!0;const e=this.getLetterFromTouch(t.touches[0].clientY);e&&(this.currentLetter=e,this.showLetterIndicator=!0,this.scrollToLetter(e))},handleTouchMove(t){if(!this.isTouching)return;const e=this.getLetterFromTouch(t.touches[0].clientY);e&&e!==this.currentLetter&&(this.currentLetter=e,this.scrollToLetter(e))},handleTouchEnd(t){this.showLetterIndicator=!1},getLetterFromTouch(t){if(!this.letterIndexRect)return null;const e=t-this.letterIndexRect.top,o=this.letterIndexRect.height/this.indexLetters.length;let n=Math.floor(e/o);return n<0&&(n=0),n>=this.indexLetters.length&&(n=this.indexLetters.length-1),this.indexLetters[n]}}};if(!Array){t.resolveComponent("uni-icons")()}Math;const n=t._export_sfc(o,[["render",function(e,o,n,i,r,s){return t.e({a:t.p({type:"search",size:"16",color:"#666666"}),b:t.o([t=>r.searchKeyword=t.detail.value,(...t)=>s.handleSearch&&s.handleSearch(...t)]),c:r.searchKeyword,d:t.p({type:"location",size:"18",color:"#fc3e2b"}),e:t.t(r.currentLocation),f:t.o((t=>s.selectLocation(r.currentLocation))),g:r.recentLocations.length>0},r.recentLocations.length>0?{h:t.f(r.recentLocations,((e,o,n)=>({a:t.t(e),b:o,c:t.o((t=>s.selectLocation(e)),o)})))}:{},{i:t.f(e.hotRegions,((e,o,n)=>({a:t.t(e.name),b:e.id,c:t.o((t=>s.selectLocation(e.name)),e.id)}))),j:t.f(s.filteredCityList,((e,o,n)=>({a:t.t(o),b:"letter-"+o,c:t.f(e,((e,o,n)=>({a:t.t(e.name),b:e.id,c:t.o((t=>s.selectLocation(e.name)),e.id)}))),d:o}))),k:r.scrollTop,l:t.f(s.indexLetters,((e,o,n)=>({a:t.t(e),b:e,c:e,d:t.o((t=>s.scrollToLetter(e)),e)}))),m:t.o(((...t)=>s.handleTouchStart&&s.handleTouchStart(...t))),n:t.o(((...t)=>s.handleTouchMove&&s.handleTouchMove(...t))),o:t.o(((...t)=>s.handleTouchEnd&&s.handleTouchEnd(...t))),p:r.showLetterIndicator},r.showLetterIndicator?{q:t.t(r.currentLetter)}:{},{r:e.loading},(e.loading,{}),{s:e.error},e.error?{t:t.t(e.error),v:t.o(((...t)=>s.fetchRegionList&&s.fetchRegionList(...t)))}:{})}]]);wx.createPage(n);
