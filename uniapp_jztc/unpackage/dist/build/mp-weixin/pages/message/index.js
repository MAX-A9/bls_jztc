"use strict";const e=require("../../common/vendor.js"),t=require("../../mixins/device-adapter.js"),i=require("../../mixins/share.js"),n=require("../../apis/index.js"),s=require("../../utils/message-polling.js"),a=require("../../common/assets.js"),o={components:{TabBar:()=>"../../components/tab-bar/index.js"},mixins:[t.deviceAdapter,i.shareMixin],data:()=>({tabIndex:2,isRefreshing:!1,totalUnreadCount:0,systemMessage:{lastMessage:"暂无系统通知",time:""},chatList:[],pagination:{page:1,size:20,totalCount:0,totalPage:0},swipeOptions:[{text:"已读",style:{backgroundColor:"#8F8F94"}},{text:"删除",style:{backgroundColor:"#dd524d"}}],conversationUnsubscribe:null,_readSessionIds:{}}),onLoad(){this.fetchSessionList(),this.startConversationPolling()},onShow(){this.tabIndex=3,this.startConversationPolling()},onHide(){this.stopConversationPolling()},onUnload(){this.stopConversationPolling()},methods:{startConversationPolling(){this.stopConversationPolling(),s.messagePollingService.setPollingInterval(2e3),this.conversationUnsubscribe=s.messagePollingService.setConversationParams({page:this.pagination.page,size:this.pagination.size},this.handleConversationUpdate)},stopConversationPolling(){this.conversationUnsubscribe&&(this.conversationUnsubscribe(),this.conversationUnsubscribe=null,s.messagePollingService.setPollingInterval(5e3))},handleConversationUpdate(e){if(!e)return;const{list:t,totalCount:i,totalPage:n,currentPage:s,size:a}=e;this.pagination={page:s,size:a,totalCount:i,totalPage:n},t&&t.length>0?this.chatList=t.map((e=>({...e,time:this.formatTime(e.lastTime)}))):this.chatList=[],this.chatList.forEach((e=>{this._readSessionIds&&this._readSessionIds[e.id]&&(e.unreadCount=0)}))},async handleSwipeClick(e,t){0===e.index?await this.markAsRead(t):1===e.index&&await this.deleteSession(t)},async markAsRead(t){if(!t.unreadCount||t.unreadCount<=0)e.index.showToast({title:"没有未读消息",icon:"none"});else try{e.index.showLoading({title:"处理中...",mask:!0});const i=await n.message.markMessageRead({targetId:t.targetId});if(!i||0!==i.code)throw new Error((null==i?void 0:i.message)||"标记为已读失败");{const i=this.chatList.findIndex((e=>e.id===t.id));if(-1!==i){const e=this.chatList[i].unreadCount||0;this.chatList[i].unreadCount=0,this._readSessionIds[t.id]=!0,e>0&&(this.totalUnreadCount=Math.max(0,this.totalUnreadCount-e))}e.index.showToast({title:"已标记为已读",icon:"success"})}}catch(i){console.error("标记为已读失败:",i),e.index.showToast({title:"标记为已读失败",icon:"none"})}finally{e.index.hideLoading()}},async deleteSession(t){e.index.showModal({title:"提示",content:"确定要删除此会话吗？",success:async i=>{if(i.confirm)try{e.index.showLoading({title:"处理中...",mask:!0});const i=await n.message.deleteConversation(t.id);if(!i||0!==i.code)throw new Error((null==i?void 0:i.message)||"删除会话失败");{const i=this.chatList.findIndex((e=>e.id===t.id));if(-1!==i){const e=this.chatList[i].unreadCount||0;e>0&&(this.totalUnreadCount=Math.max(0,this.totalUnreadCount-e)),this.chatList.splice(i,1)}e.index.showToast({title:"已删除会话",icon:"success"})}}catch(s){console.error("删除会话失败:",s),e.index.showToast({title:"删除会话失败",icon:"none"})}finally{e.index.hideLoading()}}})},async fetchSessionList(){try{e.index.showLoading({title:"加载中...",mask:!0});const t=await n.message.getConversationList({page:this.pagination.page,size:this.pagination.size});if(!t||0!==t.code)throw new Error((null==t?void 0:t.message)||"获取会话列表失败");{const{list:e,totalCount:i,totalPage:n,currentPage:a,size:o}=t.data;this.pagination={page:a,size:o,totalCount:i,totalPage:n},s.messagePollingService.updateConversationParams({page:a,size:o}),e&&e.length>0?this.chatList=e.map((e=>({...e,time:this.formatTime(e.lastTime)}))):this.chatList=[]}e.index.hideLoading()}catch(t){console.error("获取聊天会话列表失败:",t),e.index.showToast({title:"获取会话列表失败",icon:"none"}),e.index.hideLoading()}},handleClearUnread(){e.index.showModal({title:"提示",content:"确定要清除所有未读消息吗？",success:async t=>{if(t.confirm){e.index.showLoading({title:"处理中...",mask:!0});try{const t=await n.message.clearAllUnread();if(!t||0!==t.code)throw new Error((null==t?void 0:t.message)||"清除未读消息失败");this.chatList.forEach((e=>{e.unreadCount=0})),this.totalUnreadCount=0,e.index.showToast({title:"已清除未读消息",icon:"success"})}catch(i){console.error("清除未读消息失败:",i),e.index.showToast({title:"清除未读消息失败",icon:"none"})}finally{e.index.hideLoading()}}}})},async handleChatClick(t){e.index.navigateTo({url:`/pages/chat/detail?id=${t.targetId}&nickName=${encodeURIComponent(t.targetName||"用户")}`,success:async()=>{if(t.unreadCount&&t.unreadCount>0)try{const e=await n.message.clearSessionUnread(t.id);if(e&&0===e.code){const e=this.chatList.findIndex((e=>e.id===t.id));if(-1!==e){const i=this.chatList[e].unreadCount||0;this.chatList[e].unreadCount=0,this._readSessionIds[t.id]=!0,i>0&&(this.totalUnreadCount=Math.max(0,this.totalUnreadCount-i))}}}catch(e){console.error("清除会话未读消息失败:",e)}}})},handleSystemClick(){e.index.navigateTo({url:"/pages/notification/index"})},async onRefresh(){if(!this.isRefreshing){this.isRefreshing=!0;try{this.pagination.page=1,await this.fetchSessionList(),e.index.showToast({title:"刷新成功",icon:"success"})}catch(t){console.error("刷新失败:",t),e.index.showToast({title:"刷新失败",icon:"none"})}finally{this.isRefreshing=!1}}},onRestore(){console.log("刷新复位")},formatTime(e){if(!e)return"";let t;if("string"==typeof e){const i=e.replace(/-/g,"/");t=new Date(i)}else t=new Date(e);if(isNaN(t.getTime()))return console.error("Invalid date format:",e),"";const i=new Date,n=Math.floor((i-t)/864e5),s=t.getHours().toString().padStart(2,"0"),a=t.getMinutes().toString().padStart(2,"0");if(0===n)return`${s}:${a}`;if(1===n)return"昨天";if(n<7){return["周日","周一","周二","周三","周四","周五","周六"][t.getDay()]}return`${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-swipe-action-item")+e.resolveComponent("uni-swipe-action")+e.resolveComponent("tab-bar"))()}Math||((()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-icons/uni-icons.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-swipe-action-item/uni-swipe-action-item.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-swipe-action/uni-swipe-action.js"))();const r=e._export_sfc(o,[["render",function(t,i,n,s,o,r){return e.e({a:e.p({type:"trash",size:"16",color:"#666666"}),b:e.o(((...e)=>r.handleClearUnread&&r.handleClearUnread(...e))),c:e.p({type:"notification-filled",size:"24",color:"#fc3e2b"}),d:e.t(o.systemMessage.time||""),e:e.t(o.systemMessage.lastMessage||"暂无系统通知"),f:e.o(((...e)=>r.handleSystemClick&&r.handleSystemClick(...e))),g:e.f(o.chatList,((t,i,n)=>e.e({a:t.targetAvatar||"/static/images/default-avatar.png",b:e.t(t.targetName||"用户"),c:e.t(t.time||""),d:e.t(t.lastMessage||""),e:t.unreadCount&&t.unreadCount>0},t.unreadCount&&t.unreadCount>0?{f:e.t(t.unreadCount)}:{},{g:e.o((e=>r.handleChatClick(t)),t.id||i),h:e.o((e=>r.handleSwipeClick(e,t)),t.id||i),i:"4af1779c-3-"+n+",4af1779c-2-"+n,j:"4af1779c-2-"+n,k:t.id||i}))),h:e.p({"right-options":o.swipeOptions}),i:0===o.chatList.length},0===o.chatList.length?{j:a._imports_0}:{},{k:o.isRefreshing,l:e.o(((...e)=>r.onRefresh&&r.onRefresh(...e))),m:e.o(((...e)=>r.onRestore&&r.onRestore(...e))),n:e.p({"current-tab":o.tabIndex})})}]]);wx.createPage(r);
