"use strict";const e=require("../../common/vendor.js"),t=require("../../mixins/device.js"),n=require("../../mixins/share.js"),s=require("../../utils/request.js"),i=require("../../utils/share.js"),a={components:{TabBar:()=>"../../components/tab-bar/index.js",CommunityNews:()=>"../../components/community-news/index.js"},mixins:[t.deviceMixin,n.shareMixin],data:()=>({tabIndex:1,isRefreshing:!1,currentMenu:0,searchBoxWidth:200,rightPadding:0,menuList:[],menuLoading:!1,isHomePage:!0,shareData:null}),onLoad(){this.fetchCategories()},mounted(){const t=e.index.getMenuButtonBoundingClientRect(),n=e.index.getWindowInfo();this.searchBoxWidth=t.left-100,this.rightPadding=n.windowWidth-t.left},onShow(){this.tabIndex=1,this.updateShareData()},methods:{fetchCategories(){this.menuLoading=!0;const e={id:0,name:"全部"},t=setTimeout((()=>{this.menuLoading&&(this.useDefaultMenu(),this.menuLoading=!1,console.log("获取闲置分类超时，使用默认值"))}),3e3);s.get("/wx/client/content/categories",{type:2}).then((n=>{if(clearTimeout(t),0===n.code){const t=n.data.list||[];this.menuList=[e,...t],console.log("成功获取闲置分类:",this.menuList),this.updateShareData()}else console.error("获取闲置分类失败:",n.message||"未知错误"),this.useDefaultMenu()})).catch((e=>{clearTimeout(t),console.error("请求闲置分类接口出错:",e),this.useDefaultMenu()})).finally((()=>{clearTimeout(t),this.menuLoading=!1}))},useDefaultMenu(){this.menuList=[{id:0,name:"全部"}]},handleSearch(){e.index.navigateTo({url:"/pages/search/index"})},switchMenu(t){this.currentMenu=t;const n=this.menuList[t],s=n?n.id:0;e.index.$emit("idleCategoryChanged",{categoryId:s}),console.log("切换到分类:",n.name,"ID:",s)},async onRefresh(){if(!this.isRefreshing){this.isRefreshing=!0;try{this.fetchCategories(),this.$refs.newsComponent&&this.$refs.newsComponent.resetAndLoad(),await this.refreshData(),this.updateShareData()}catch(e){console.error("刷新失败:",e)}finally{this.isRefreshing=!1}}},async refreshData(){await new Promise((e=>setTimeout(e,1e3)))},handleScrollToLower(){console.log("触发上拉加载更多"),this.$refs.newsComponent&&this.$refs.newsComponent.loadMore()},async updateShareData(){try{const e=await i.getShareSettings();if(e){const t=e.content_share_text||"查看闲置社区",n=e.content_share_image||"";this.shareData={title:t,imageUrl:n,path:"/pages/community/index"},console.log("闲置社区分享数据已更新:",this.shareData)}else this.initShareData()}catch(e){console.error("更新分享数据失败:",e),this.initShareData()}},handleShare(){this.updateShareData(),e.index.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]})}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("community-news")+e.resolveComponent("tab-bar"))()}Math;const o=e._export_sfc(a,[["render",function(t,n,s,i,a,o){return{a:e.p({type:"search",size:"16",color:"#666666"}),b:e.o(((...e)=>o.handleSearch&&o.handleSearch(...e))),c:a.searchBoxWidth+"px",d:t.navBarHeight+"px",e:a.rightPadding+"px",f:t.statusBarHeight+"px",g:e.f(a.menuList,((t,n,s)=>({a:e.t(t.name),b:n,c:a.currentMenu===n?1:"",d:e.o((e=>o.switchMenu(n)),n)}))),h:e.sr("newsComponent","78e76304-1"),i:a.isRefreshing,j:e.o(((...e)=>o.onRefresh&&o.onRefresh(...e))),k:e.o(((...e)=>t.onRestore&&t.onRestore(...e))),l:e.o(((...e)=>o.handleScrollToLower&&o.handleScrollToLower(...e))),m:t.navigationBarHeight+"px",n:e.p({"current-tab":a.tabIndex})}}]]);wx.createPage(o);
