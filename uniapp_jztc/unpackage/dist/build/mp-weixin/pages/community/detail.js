"use strict";const e=require("../../common/vendor.js"),a=require("../../mixins/device-adapter.js"),t=require("../../mixins/share.js"),o=require("../../apis/content.js"),i=require("../../utils/date.js"),s=require("../../utils/request.js"),n=require("../../utils/share.js"),r={mixins:[a.deviceAdapter,t.shareMixin],components:{ActionBar:()=>"../../components/action-bar/index.js"},onLoad(a){const t=a.id;console.log("商品ID:",t),t?(this.goodsId=t,this.loadGoodsData(t),this.loadBannerData()):e.index.showToast({title:"缺少商品ID",icon:"none"})},data:()=>({goodsId:null,goodsData:{id:"",title:"",price:"0",originalPrice:"0",condition:"",location:"",detailLocation:"",tradeMethod:"线下交易",description:"",images:[],publisher_avatar:"",publisher_name:"",publisher_id:"",publish_count:0,likes:0,viewCount:0,comments:[],cover:""},loading:!1,loadError:!1,errorMsg:"",isFollowed:!1,isCollected:!1,currentSwiperIndex:0,commentLoading:!1,defaultLocation:"江西南昌-青山湖区-高新大道1888号",bannerList:[],currentBannerIndex:0,isContentPage:!0,shareData:null}),computed:{pageTitle:()=>"闲置详情",pageStyle(){return{"--nav-height":`${this.layoutSize.navHeight}px`,"--content-padding":`${this.layoutSize.contentPadding}rpx`}},processedDescription(){if(!this.goodsData.description)return"";return this.goodsData.description.replace(/<p/g,'<p class="rich-paragraph"').replace(/<span/g,'<span class="rich-text"').replace(/<div/g,'<div class="rich-paragraph"')}},methods:{handleBack(){e.index.navigateBack()},previewImage(a){e.index.previewImage({current:a,urls:this.goodsData.images})},async handleFollow(){try{const a=this.goodsData.publisher_id;if(!a)return void e.index.showToast({title:"无法获取发布者信息",icon:"none"});let t;if(e.index.showLoading({title:this.isFollowed?"取消关注中...":"关注中...",mask:!0}),t=this.isFollowed?await o.unfollowUser({publisher_id:a}):await o.followUser({publisher_id:a}),e.index.hideLoading(),!t||0!==t.code)throw new Error((null==t?void 0:t.message)||"操作失败");await this.loadFollowStatus(String(a)),e.index.showToast({title:this.isFollowed?"已关注":"已取消关注",icon:"success"})}catch(a){e.index.hideLoading(),console.error("关注操作失败:",a),e.index.showToast({title:a.message||"操作失败，请重试",icon:"none"})}},async handleCollect(){try{let a;if(e.index.showLoading({title:this.isCollected?"取消收藏中...":"收藏中...",mask:!0}),a=this.isCollected?await o.cancelFavorite(this.goodsId):await o.addFavorite(this.goodsId),e.index.hideLoading(),0!==a.code)throw new Error(a.message||"操作失败");this.isCollected=!this.isCollected,e.index.showToast({title:this.isCollected?"已收藏":"已取消收藏",icon:"success"})}catch(a){e.index.hideLoading(),console.error("收藏操作失败:",a),e.index.showToast({title:a.message||"操作失败，请重试",icon:"none"})}},handleMessage(){const a=this.goodsData.publisher_id||"";a?e.index.navigateTo({url:`/pages/chat/detail?userId=${a}&userName=${this.goodsData.publisher_name}`,success:()=>{console.log("跳转到私信页面成功")},fail:a=>{console.error("跳转到私信页面失败:",a),e.index.showToast({title:"无法打开私信",icon:"none"})}}):e.index.showToast({title:"无法获取发布者信息",icon:"none"})},handleShare(){this.updateShareData(),e.index.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]})},filterImgTags:e=>e?e.replace(/<img[^>]*>/g,""):"",formatPublishTime:e=>e?i.formatTimeAgo(e):"",async loadGoodsData(a){this.loading=!0;try{const e=await o.getPublicContentDetail(a);if(0!==e.code||!e.data)throw new Error(e.message||"获取商品详情失败");{const a=e.data,t=this.filterImgTags(a.content);this.formatPublishTime(a.publishTime);this.goodsData={id:a.id,title:a.title||"",price:a.price||0,originalPrice:a.originalPrice||0,description:t||"",images:a.images||[],condition:a.condition||"",location:a.location||"",detailLocation:a.tradePlace||this.defaultLocation,tradeMethod:a.tradeMethod||"线下交易",publisher_avatar:a.publisherAvatar||"",publisher_name:a.publisher||"匿名用户",publisher_id:a.publisherId||a.publisher_id||"",publish_count:a.publishCount||0,likes:a.likes||0,viewCount:a.views||0,comments:[],cover:a.cover||""},this.loadComments(),this.loadFavoriteStatus(),this.goodsData.publisher_id&&this.loadPublisherInfo(),this.updateShareData()}}catch(t){console.error("加载商品详情失败:",t),e.index.showToast({title:"加载商品详情失败",icon:"none"})}finally{this.loading=!1}},async loadFavoriteStatus(){if(this.goodsId)try{const e=await o.getFavoriteStatus(this.goodsId);0===e.code&&e.data&&(this.isCollected=e.data.isFavorite)}catch(e){console.error("获取收藏状态失败:",e)}},async loadComments(){if(this.goodsData.id){this.commentLoading=!0;try{const e=await o.getCommentList(this.goodsData.id,{page:1,pageSize:10});0===e.code&&e.data?(this.goodsData.comments=(e.data.list||[]).map((e=>({id:e.id,avatar:e.avatarUrl||"",name:e.realName||"匿名用户",content:e.comment||"",time:this.formatPublishTime(e.createdAt)}))),void 0!==e.data.total&&(this.goodsData.commentCount=e.data.total)):console.error("获取评论列表失败:",e.message)}catch(e){console.error("加载评论失败:",e)}finally{this.commentLoading=!1}}},handleComment(){e.index.showModal({title:"留言",editable:!0,placeholderText:"请输入留言内容",success:async a=>{if(a.confirm&&a.content){let i=!1;try{const t={comment:a.content,contentId:this.goodsData.id};e.index.showLoading({title:"提交中..."}),i=!0;const s=await o.createComment(t);if(e.index.hideLoading(),i=!1,0!==s.code)throw new Error(s.message||"评论失败");e.index.showToast({title:"留言成功",icon:"success"}),this.loadComments()}catch(t){i&&(e.index.hideLoading(),i=!1),console.error("提交评论失败:",t),e.index.showToast({title:t.message||"留言失败，请重试",icon:"none"})}finally{i&&e.index.hideLoading()}}}})},handleSwiperChange(e){this.currentSwiperIndex=e.detail.current},handleBannerClick(a){a&&a.linkUrl&&("page"===a.linkType?e.index.navigateTo({url:"/"+a.linkUrl,fail:e=>{console.error("页面跳转失败",a.linkUrl,e)}}):"webview"===a.linkType?e.index.navigateTo({url:"/pages/webview/index?url="+encodeURIComponent(a.linkUrl),fail:e=>{console.error("网页跳转失败",a.linkUrl,e)}}):"miniprogram"===a.linkType&&e.index.navigateToMiniProgram({appId:a.linkUrl,fail:t=>{console.error("小程序跳转失败",a.linkUrl,t),e.index.showToast({title:"跳转失败",icon:"none"})}}))},handleBannerSwiperChange(e){this.currentBannerIndex=e.detail.current},copyLocation(){e.index.setClipboardData({data:this.goodsData.detailLocation||this.defaultLocation,success:()=>{e.index.showToast({title:"地址已复制",icon:"success"})}})},async loadPublisherInfo(){try{const e=this.goodsData.publisher_id;if(!e)return void console.error("无法加载发布者信息: publisher_id不存在");const a=String(e),t=await o.getPublisherInfo(a);if(t&&0===t.code&&t.data){const e=t.data;e.real_name&&(this.goodsData.publisher_name=e.real_name),e.avatar_url&&(this.goodsData.publisher_avatar=e.avatar_url),void 0!==e.publish_count&&(this.goodsData.publish_count=e.publish_count),await this.loadFollowStatus(a)}else console.error("获取发布者信息失败:",(null==t?void 0:t.message)||"未知错误")}catch(e){console.error("加载发布者信息异常:",e)}},async loadFollowStatus(e){try{if(!e)return void console.error("无法获取关注状态: publisher_id不存在");const a=await o.getPublisherFollowStatus(e);a&&0===a.code&&a.data?this.isFollowed=!!a.data.is_followed:console.error("获取关注状态失败:",(null==a?void 0:a.message)||"未知错误")}catch(a){console.error("加载关注状态异常:",a)}},async loadBannerData(){try{const e=await s.get("/wx/inner-banner/list",{bannerType:"idle"});e&&0===e.code&&e.data&&e.data.isGlobalEnabled&&e.data.list&&e.data.list.length>0&&(this.bannerList=e.data.list.filter((e=>e.isEnabled)).sort(((e,a)=>e.order-a.order)))}catch(e){console.error("获取轮播图数据失败",e)}},async updateShareData(){try{const e=await n.getShareSettings();if(e&&this.goodsData){const a=this.goodsData.title||e.content_share_text||"查看闲置商品";let t="";this.goodsData.images&&this.goodsData.images.length>0?t=this.goodsData.images[0]:e.content_share_image&&(t=e.content_share_image),this.goodsData.cover=t,this.shareData={title:a,imageUrl:t,path:`/pages/community/detail?id=${this.goodsId}`},console.log("闲置商品分享数据已更新:",this.shareData)}else this.initShareData()}catch(e){console.error("更新分享数据失败:",e),this.initShareData()}},onShow(){this.updateShareData()}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("action-bar"))()}Math;const l=e._export_sfc(r,[["render",function(a,t,o,i,s,n){return e.e({a:e.p({type:"left",size:"20",color:"#333333"}),b:e.o(((...e)=>n.handleBack&&n.handleBack(...e))),c:e.t(n.pageTitle),d:a.statusBarHeight+"px",e:s.loading},(s.loading,{}),{f:!s.loading},s.loading?{}:e.e({g:e.f(s.goodsData.images,((a,t,o)=>({a:a,b:e.o((e=>n.previewImage(t)),t),c:t}))),h:e.o(((...e)=>n.handleSwiperChange&&n.handleSwiperChange(...e))),i:s.goodsData.images&&s.goodsData.images.length>0},s.goodsData.images&&s.goodsData.images.length>0?{j:e.t(s.currentSwiperIndex+1),k:e.t(s.goodsData.images.length)}:{},{l:e.t(s.goodsData.price),m:s.goodsData.originalPrice},s.goodsData.originalPrice?{n:e.t(s.goodsData.originalPrice)}:{},{o:e.t(s.goodsData.likes||0),p:e.t(s.goodsData.viewCount),q:e.t(s.goodsData.title),r:n.processedDescription,s:e.t(s.goodsData.detailLocation||s.defaultLocation),t:e.o(((...e)=>n.copyLocation&&n.copyLocation(...e))),v:e.t(s.goodsData.tradeMethod),w:s.goodsData.publisher_avatar,x:e.t(s.goodsData.publisher_name),y:e.t(s.goodsData.publish_count),z:e.t(s.isFollowed?"已关注":"关注"),A:e.o(((...e)=>n.handleFollow&&n.handleFollow(...e))),B:s.bannerList.length>0},s.bannerList.length>0?e.e({C:e.f(s.bannerList,((a,t,o)=>({a:a.image,b:t,c:e.o((e=>n.handleBannerClick(a)),t)}))),D:e.o(((...e)=>n.handleBannerSwiperChange&&n.handleBannerSwiperChange(...e))),E:s.bannerList.length>1},s.bannerList.length>1?{F:e.f(s.bannerList,((e,a,t)=>({a:a,b:s.currentBannerIndex===a?1:""})))}:{}):{},{G:e.t(s.goodsData.commentCount||0),H:e.p({type:"chat",size:"14",color:"#007AFF"}),I:e.o(((...e)=>n.handleComment&&n.handleComment(...e))),J:s.goodsData.comments&&s.goodsData.comments.length},s.goodsData.comments&&s.goodsData.comments.length?{K:e.f(s.goodsData.comments,((a,t,o)=>({a:a.avatar,b:e.t(a.name),c:e.t(a.content),d:e.t(a.time),e:t})))}:{}),{L:a.navigationBarHeight+"px",M:e.o(n.handleComment),N:e.o(n.handleCollect),O:e.o(n.handleShare),P:e.o(n.handleMessage),Q:e.p({"is-collected":s.isCollected,publisher:{id:s.goodsData.publisher_id,name:s.goodsData.publisher_name}}),R:e.s(n.pageStyle)})}]]);wx.createPage(l);
