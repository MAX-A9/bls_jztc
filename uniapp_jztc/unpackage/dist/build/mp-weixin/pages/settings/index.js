"use strict";const e=require("../../common/vendor.js"),t=require("../../apis/index.js"),o=require("../../utils/storage.js"),n=require("../../utils/device-info.js"),a={data:()=>({statusBarHeight:0,navBarHeight:44,userInfo:{avatar:"/static/demo/0.png",nickname:"橘子用户",phone:""},notifications:{message:!0,comment:!0},cacheSize:"8.5MB",updateData:{},appInfo:{name:"橘子同城",description:"为您提供便捷的本地生活服务"},showAboutPopup:!1}),computed:{...e.mapGetters("user",["isLoggedIn"])},onLoad(){this.statusBarHeight=n.deviceInfo.getStatusBarHeight(),this.loadUserInfo(),this.updateCacheSize(),this.fetchAppBaseInfo()},methods:{...e.mapActions("user",["getUserInfo"]),async loadUserInfo(){if(this.isLoggedIn)try{await this.getUserInfo();const e=o.getUserInfo();this.userInfo={avatar:e.avatarUrl||"/static/demo/0.png",nickname:e.realName||"橘子用户",phone:e.phone||""}}catch(t){console.error("加载用户信息失败:",t),e.index.showToast({title:"加载用户信息失败",icon:"none"})}},handleBack(){e.index.navigateBack()},async onChooseAvatar(o){try{const{avatarUrl:a}=o.detail;if(!a)return;e.index.showLoading({title:"处理中..."}),this.userInfo.avatar=a;try{await t.user.uploadAvatar(a);await this.getUserInfo(),e.index.hideLoading(),e.index.showToast({title:"头像已更新",icon:"success"})}catch(n){e.index.hideLoading(),e.index.showToast({title:"头像更新失败: "+(n.message||"未知错误"),icon:"none",duration:3e3})}}catch(n){e.index.hideLoading(),e.index.showToast({title:"更新头像失败",icon:"none"})}},async onNicknameInput(t){try{const o=t.detail.value;if(!o||o===this.userInfo.nickname)return;this.userInfo.nickname=o,this.updateData.realName=o,await this.saveUserInfo(),e.index.showToast({title:"昵称已更新",icon:"success"})}catch(o){console.error("更新昵称失败:",o),e.index.showToast({title:"更新昵称失败",icon:"none"})}},handleEditPhone(){e.index.showModal({title:"修改手机号",editable:!0,placeholderText:"请输入11位手机号",content:this.userInfo.phone||"",success:async t=>{if(t.confirm&&t.content){const n=t.content;if(!/^1\d{10}$/.test(n))return void e.index.showToast({title:"请输入有效的手机号",icon:"none"});if(n===this.userInfo.phone)return;try{this.userInfo.phone=n,this.updateData.phone=n,e.index.showLoading({title:"更新中..."}),await this.saveUserInfo(),e.index.hideLoading(),e.index.showToast({title:"手机号已更新",icon:"success"})}catch(o){e.index.hideLoading(),console.error("更新手机号失败:",o),e.index.showToast({title:"更新手机号失败",icon:"none"})}}}})},async saveUserInfo(){if(0!==Object.keys(this.updateData).length)try{return await t.user.updateClientProfile(this.updateData),this.getUserInfo(),this.updateData={},!0}catch(e){throw console.error("保存用户信息失败:",e),e}},handleSwitchChange(e,t){this.notifications[e]=t.detail.value},handleClearCache(){e.index.showModal({title:"提示",content:"确定要清除缓存吗？",success:t=>{if(t.confirm)try{e.index.showLoading({title:"清除中...",mask:!0});const t=["token","USER_INFO","currentLocation"];e.index.getStorageInfo({success:o=>{(o.keys||[]).filter((e=>!t.includes(e))).forEach((t=>{e.index.removeStorageSync(t)})),e.index.getSavedFileList({success:t=>{(t.fileList||[]).forEach((t=>{e.index.removeSavedFile({filePath:t.filePath,fail:()=>{}})}))},complete:()=>{}}),setTimeout((()=>{this.updateCacheSize(),e.index.hideLoading(),e.index.showToast({title:"缓存已清除",icon:"success"})}),500)},fail:()=>{e.index.hideLoading(),e.index.showToast({title:"清除缓存失败",icon:"none"})}})}catch(o){console.error("清除缓存出错:",o),e.index.hideLoading(),e.index.showToast({title:"清除缓存失败",icon:"none"})}}})},updateCacheSize(){try{e.index.getStorageInfo({success:e=>{const t=e.currentSize||0;if(t<1024)this.cacheSize=t+"KB";else{const e=(t/1024).toFixed(1);this.cacheSize=e+"MB"}},fail:()=>{this.cacheSize="0KB"}})}catch(t){console.error("获取缓存大小失败:",t),this.cacheSize="未知"}},handleAbout(){this.showAboutPopup=!0},async fetchAppBaseInfo(){try{const e=await t.settings.getBaseSettings();0===e.code&&e.data?(e.data.name&&(this.appInfo.name=e.data.name),e.data.description&&(this.appInfo.description=e.data.description)):console.error("获取应用基础信息失败:",e.message||"未知错误")}catch(e){console.error("请求应用基础信息接口出错:",e)}},handleAgreement(t){const o="service"===t?"user":"privacy";e.index.navigateTo({url:`/pages/agreement/index?type=${o}`})}}};if(!Array){e.resolveComponent("uni-icons")()}Math;const i=e._export_sfc(a,[["render",function(t,o,n,a,i,s){return e.e({a:e.p({type:"left",size:"20",color:"#333333"}),b:e.o(((...e)=>s.handleBack&&s.handleBack(...e))),c:i.navBarHeight+"px",d:i.statusBarHeight+"px",e:i.userInfo.avatar,f:e.o(((...e)=>s.onChooseAvatar&&s.onChooseAvatar(...e))),g:e.p({type:"right",size:"16",color:"#CCCCCC"}),h:i.userInfo.nickname||"请输入昵称",i:e.o(((...e)=>s.onNicknameInput&&s.onNicknameInput(...e))),j:e.p({type:"right",size:"16",color:"#CCCCCC"}),k:e.t(i.userInfo.phone||"未设置"),l:e.p({type:"right",size:"16",color:"#CCCCCC"}),m:e.o(((...e)=>s.handleEditPhone&&s.handleEditPhone(...e))),n:i.notifications.message,o:e.o((e=>s.handleSwitchChange("message",e))),p:i.notifications.comment,q:e.o((e=>s.handleSwitchChange("comment",e))),r:e.t(i.cacheSize),s:e.p({type:"right",size:"16",color:"#CCCCCC"}),t:e.o(((...e)=>s.handleClearCache&&s.handleClearCache(...e))),v:e.p({type:"right",size:"16",color:"#CCCCCC"}),w:e.o(((...e)=>s.handleAbout&&s.handleAbout(...e))),x:e.o((e=>s.handleAgreement("service"))),y:e.o((e=>s.handleAgreement("privacy"))),z:`calc(${i.statusBarHeight}px + ${i.navBarHeight}px)`,A:i.showAboutPopup},i.showAboutPopup?{B:e.t(i.appInfo.name),C:e.t(i.appInfo.description),D:e.o((e=>i.showAboutPopup=!1))}:{})}]]);wx.createPage(i);
