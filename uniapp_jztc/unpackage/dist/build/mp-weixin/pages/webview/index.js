"use strict";const t=require("../../common/vendor.js"),e={data:()=>({webUrl:"",originalUrl:"",securityEnabled:!1,urlTitle:""}),onLoad(e){if(e.url)try{this.originalUrl=decodeURIComponent(e.url)||"",e.title?(this.urlTitle=decodeURIComponent(e.title),t.index.setNavigationBarTitle({title:this.urlTitle})):t.index.setNavigationBarTitle({title:"网页浏览"}),this.enableWebViewSecurity(),this.setSecureWebUrl(this.originalUrl)}catch(r){console.error("URL解析错误:",r),t.index.showToast({title:"无效的链接",icon:"none"}),setTimeout((()=>{t.index.navigateBack()}),1500)}else t.index.showToast({title:"缺少URL参数",icon:"none"}),setTimeout((()=>{t.index.navigateBack()}),1500)},mounted(){this.disableSharedArrayBuffer()},methods:{enableWebViewSecurity(){void 0!==t.wx$1&&t.wx$1.setWebViewSecurity&&t.wx$1.setWebViewSecurity({enable:!0,success:()=>{console.log("成功启用WebView安全模式"),this.securityEnabled=!0},fail:t=>{console.error("启用WebView安全模式失败:",t)}})},disableSharedArrayBuffer(){void 0!==t.wx$1&&t.wx$1.onWebViewLoad&&t.wx$1.onWebViewLoad((()=>{try{console.log("WebView加载完成，应用安全措施"),this.injectSecurityScript()}catch(t){console.error("WebView安全处理失败:",t)}}))},injectSecurityScript(){if(void 0!==t.wx$1&&t.wx$1.evaluateWebView){const e="\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t// 阻止使用SharedArrayBuffer\n\t\t\t\t\t\t\tif (typeof SharedArrayBuffer !== 'undefined') {\n\t\t\t\t\t\t\t\tconsole.warn('检测到SharedArrayBuffer，但已被安全策略禁用');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// 添加必要的安全头\n\t\t\t\t\t\t\tconst meta = document.createElement('meta');\n\t\t\t\t\t\t\tmeta.httpEquiv = 'Cross-Origin-Embedder-Policy';\n\t\t\t\t\t\t\tmeta.content = 'require-corp';\n\t\t\t\t\t\t\tdocument.head.appendChild(meta);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tconst meta2 = document.createElement('meta');\n\t\t\t\t\t\t\tmeta2.httpEquiv = 'Cross-Origin-Opener-Policy';\n\t\t\t\t\t\t\tmeta2.content = 'same-origin';\n\t\t\t\t\t\t\tdocument.head.appendChild(meta2);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\ttrue; // 返回执行结果\n\t\t\t\t\t\t} catch(e) {\n\t\t\t\t\t\t\tconsole.error('安全脚本执行出错:', e);\n\t\t\t\t\t\t\tfalse; // 返回执行结果\n\t\t\t\t\t\t}\n\t\t\t\t\t";t.wx$1.evaluateWebView({webviewId:"webviewId",script:e,success:t=>{console.log("安全脚本注入成功",t)},fail:t=>{console.error("安全脚本注入失败:",t)}})}},setSecureWebUrl(t){if(t)try{let e=t;if(t.startsWith("http")&&!t.includes("coop=cross-origin")&&!t.includes("coep=require-corp")){const r=t.includes("?")?"&":"?";e=`${t}${r}coop=cross-origin&coep=require-corp`}console.log("使用安全URL:",e),this.webUrl=e}catch(e){console.error("处理URL时出错:",e),this.webUrl=t}else this.webUrl=""},handleMessage(t){console.log("收到web-view消息:",t)},handleError(e){console.error("web-view加载错误:",e),t.index.showToast({title:"页面加载出错",icon:"none"})}}};const r=t._export_sfc(e,[["render",function(e,r,i,n,o,s){return t.e({a:!o.webUrl},(o.webUrl,{}),{b:o.webUrl,c:t.o(((...t)=>s.handleMessage&&s.handleMessage(...t))),d:t.o(((...t)=>s.handleError&&s.handleError(...t)))})}]]);wx.createPage(r);
