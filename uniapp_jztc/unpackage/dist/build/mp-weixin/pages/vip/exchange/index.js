"use strict";const e=require("../../../common/vendor.js"),t=require("../../../mixins/device.js"),n=require("../../../mixins/share.js"),a=require("../../../utils/request.js"),s=require("../../../apis/index.js"),r=require("../../../utils/share.js"),i={components:{uniIcons:()=>"../../../node-modules/@dcloudio/uni-ui/lib/uni-icons/uni-icons.js",exchangePopup:()=>"../../../components/exchange-popup/index.js"},mixins:[t.deviceMixin,n.shareMixin],data:()=>({recentExchanges:[],currentTab:0,tabList:["全部"],memberDays:"0",memberHours:"0",memberMinutes:"0",categories:[],products:[],page:1,size:10,currentCategoryId:null,currentProduct:null,shareImageUrl:""}),onLoad(){this.getMemberDuration(),this.getCategoryList(),this.getRecentExchangeRecords(),this.getShareImage()},onShareAppMessage(){return{title:"兑换视频会员权益",path:"/pages/vip/exchange/index",imageUrl:this.shareImageUrl}},onShareTimeline(){return{title:"兑换视频会员权益",query:"",imageUrl:this.shareImageUrl}},methods:{async getShareImage(){try{const e=await r.getShareSettings();e&&e.default_share_image&&(this.shareImageUrl=e.default_share_image)}catch(e){console.error("获取分享图片失败:",e)}},handleBack(){e.index.navigateBack()},handleExchangeRecord(){e.index.navigateTo({url:"/pages/vip/exchange/record"})},async getRecentExchangeRecords(){try{const e=await s.vip.getRecentExchangeRecords();0===e.code&&e.data?this.recentExchanges=e.data.list||[]:console.error("获取最近兑换记录失败:",null==e?void 0:e.message)}catch(e){console.error("获取最近兑换记录异常:",e)}},switchTab(e){this.currentTab=e,0===e?this.currentCategoryId=null:this.categories.length>0&&e-1<this.categories.length&&(this.currentCategoryId=this.categories[e-1].id),this.getProductList()},handleExchangeVip(t){this.currentProduct=t,this.$nextTick((()=>{this.$refs.exchangePopup?this.$refs.exchangePopup.open(t):e.index.showToast({title:"组件加载中，请稍后再试",icon:"none"})}))},handleConfirmExchange(e){this.exchangeProduct(e)},async exchangeProduct(t){if(t)try{e.index.showLoading({title:"兑换中..."});const n=await s.vip.createExchangeRecord(t);e.index.hideLoading(),0===n.code?(e.index.showToast({title:"兑换成功",icon:"success",duration:2e3}),setTimeout((()=>{this.getMemberDuration(),this.getRecentExchangeRecords()}),1e3)):e.index.showToast({title:n.msg||"兑换失败",icon:"none"})}catch(n){e.index.hideLoading(),console.error("兑换失败:",n),e.index.showToast({title:"兑换失败，请重试",icon:"none"})}},async getMemberDuration(){try{const e=await a.get("/wx/client/duration/remaining");if(0===e.code&&e.data){const t=e.data.remainingDuration||"0天0小时0分钟";this.memberDays=t.match(/(\d+)天/)?t.match(/(\d+)天/)[1]:"0",this.memberHours=t.match(/(\d+)小时/)?t.match(/(\d+)小时/)[1]:"0",this.memberMinutes=t.match(/(\d+)分钟/)?t.match(/(\d+)分钟/)[1]:"0"}else console.error("获取会员时长失败:",null==e?void 0:e.message)}catch(e){console.error("获取会员时长异常:",e)}},async getCategoryList(){try{const e=await a.get("/wx/client/shop-category/list");0===e.code&&e.data&&e.data.list&&e.data.list.length>0&&(this.categories=e.data.list,this.tabList=["全部",...e.data.list.map((e=>e.name))],this.getProductList())}catch(e){console.error("获取平台分类列表失败:",e)}},async getProductList(){try{e.index.showLoading({title:"加载中..."});const t={page:this.page,size:this.size};this.currentCategoryId&&(t.categoryId=this.currentCategoryId);const n=await a.get("/wx/product/list",t);0===n.code&&n.data?this.products=n.data.list||[]:(console.error("获取产品列表失败:",null==n?void 0:n.message),this.products=[])}catch(t){console.error("获取产品列表异常:",t),this.products=[]}finally{e.index.hideLoading()}}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("exchange-popup"))()}Math;const c=e._export_sfc(i,[["render",function(t,n,a,s,r,i){return e.e({a:t.statusBarHeight+"px",b:e.p({type:"left",size:"20",color:"#ffecd8"}),c:e.o(((...e)=>i.handleBack&&i.handleBack(...e))),d:r.recentExchanges.length>0},r.recentExchanges.length>0?{e:e.f(r.recentExchanges,((t,n,a)=>e.e({a:e.t(t.clientName),b:e.t(t.productName),c:n<r.recentExchanges.length-1},(r.recentExchanges.length,{}),{d:n})))}:{},{f:r.recentExchanges.length>0},r.recentExchanges.length>0?{g:e.f(r.recentExchanges,((t,n,a)=>e.e({a:e.t(t.clientName),b:e.t(t.productName),c:n<r.recentExchanges.length-1},(r.recentExchanges.length,{}),{d:n})))}:{},{h:e.o(((...e)=>i.handleExchangeRecord&&i.handleExchangeRecord(...e))),i:e.t(r.memberDays),j:e.t(r.memberHours),k:e.t(r.memberMinutes),l:e.f(r.tabList,((t,n,a)=>({a:e.t(t),b:n,c:r.currentTab===n?1:"",d:e.o((e=>i.switchTab(n)),n)}))),m:r.products.length>0},r.products.length>0?{n:e.f(r.products,((t,n,a)=>e.e({a:t.tags},t.tags?{b:e.t(t.tags)}:{},{c:t.thumbnail,d:e.t(t.name),e:e.t(t.description),f:e.t(t.duration),g:e.o((e=>i.handleExchangeVip(t)),t.id),h:t.id})))}:{},{o:0===r.products.length},(r.products.length,{}),{p:e.sr("exchangePopup","0f245fb6-1"),q:e.o(i.handleConfirmExchange)})}]]);i.__runtimeHooks=6,wx.createPage(c);
