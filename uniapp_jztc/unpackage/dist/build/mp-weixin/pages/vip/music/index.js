"use strict";const e=require("../../../common/vendor.js"),t=require("../../../mixins/device.js"),a=require("../../../mixins/share.js"),i=require("../../../utils/request.js"),o=require("../../../utils/storage.js"),s=require("../../../utils/share.js"),r=require("../../../common/assets.js"),n={mixins:[t.deviceMixin,a.shareMixin],data:()=>({platforms:[],packages:[],currentCategoryId:null,adInfo:{enableWxAd:!1,rewardedVideoAdId:""},videoAd:null,isLoading:!1,userAvatar:"/static/images/default-avatar.png",memberDuration:{days:"0",hours:"0"},shareImageUrl:""}),computed:{...e.mapState("user",["userInfo","isLogin"])},onLoad(){this.getAdSettings(),this.getPlatformList(),this.getUserAvatar(),this.getMemberDuration(),this.getShareImage()},onShareAppMessage(){return{title:"天天领音乐会员",path:"/pages/vip/music/index",imageUrl:this.shareImageUrl}},onShareTimeline(){return{title:"天天领音乐会员",query:"",imageUrl:this.shareImageUrl}},methods:{getUserAvatar(){try{if(this.isLogin&&this.userInfo&&this.userInfo.avatarUrl)return void(this.userAvatar=this.userInfo.avatarUrl);const e=o.getUserInfo();e&&e.avatarUrl?this.userAvatar=e.avatarUrl:this.userAvatar="https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0"}catch(e){console.error("获取用户头像失败",e),this.userAvatar="https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0"}},async getPlatformList(){try{const e=await i.get("/wx/client/shop-category/list");0===e.code&&e.data&&e.data.list&&e.data.list.length>0&&(this.platforms=e.data.list.map((e=>({id:e.id,name:e.name,icon:e.image}))),this.platforms.length>0&&(this.currentCategoryId=this.platforms[0].id,this.getPackageList(this.currentCategoryId)))}catch(e){console.error("获取平台列表失败",e)}},async getPackageList(t){try{console.log("开始获取会员套餐列表，分类ID:",t),e.index.showLoading({title:"加载中..."});const a=await i.request({url:"/wx/product/list",method:"GET",data:{categoryId:t}});e.index.hideLoading(),console.log("套餐接口响应:",JSON.stringify(a)),this.packages=[],0===a.code?a.data&&a.data.list&&a.data.list.length>0?setTimeout((()=>{this.packages=a.data.list.map((e=>({id:e.id,tag:e.tags,name:e.name,price:e.price.toFixed(2),days:e.duration,description:e.description}))),console.log("处理后的套餐数据:",JSON.stringify(this.packages))}),100):console.log("当前平台没有可用套餐"):console.log("接口请求失败:",a.message||"未知错误")}catch(a){e.index.hideLoading(),console.error("获取会员套餐列表失败",a)}},selectPlatform(e){console.log("选择平台:",e,"当前平台:",this.currentCategoryId),this.currentCategoryId!==e&&(this.currentCategoryId=e,this.getPackageList(e))},async getAdSettings(){let t=!1;try{t=!0,e.index.showLoading({title:"加载中..."});const a=await i.request({url:"/wx/ad/settings",method:"GET"});a&&0===a.code?(this.adInfo=a.data,this.adInfo.enableWxAd&&this.adInfo.rewardedVideoAdId&&this.createRewardedVideoAd()):console.error("获取广告设置失败:",null==a?void 0:a.message)}catch(a){console.error("获取广告设置异常:",a)}finally{t&&e.index.hideLoading()}},createRewardedVideoAd(){e.wx$1&&e.wx$1.createRewardedVideoAd?(this.videoAd=e.wx$1.createRewardedVideoAd({adUnitId:this.adInfo.rewardedVideoAdId}),this.videoAd.onLoad((()=>{console.log("激励视频广告加载成功")})),this.videoAd.onError((t=>{console.error("激励视频广告出错:",t),e.index.showToast({title:"广告加载失败",icon:"none"})})),this.videoAd.onClose((t=>{t&&t.isEnded?this.reportAdViewed():e.index.showToast({title:"请完整观看广告才能获得奖励",icon:"none"})}))):console.error("当前环境不支持激励视频广告")},showRewardedVideoAd(){this.videoAd?this.videoAd.show().catch((()=>{this.videoAd.load().then((()=>this.videoAd.show())).catch((t=>{console.error("激励视频广告显示失败:",t),e.index.showToast({title:"广告加载失败，请稍后再试",icon:"none"})}))})):e.index.showToast({title:"广告加载中，请稍后再试",icon:"none"})},async reportAdViewed(){var t;if(this.isLoading)return;this.isLoading=!0;let a=!1;try{a=!0,e.index.showLoading({title:"领取奖励中..."});const o=await i.post("/wx/ad/reward/viewed");if(o&&0===o.code){const i=(null==(t=o.data)?void 0:t.message)||"恭喜获得会员奖励！";a&&(e.index.hideLoading(),a=!1),e.index.showToast({title:i,icon:"success",duration:3e3}),setTimeout((()=>{this.refreshUserInfo()}),2e3)}else a&&(e.index.hideLoading(),a=!1),e.index.showToast({title:(null==o?void 0:o.message)||"领取失败，请重试",icon:"none"})}catch(o){console.error("上报广告观看失败:",o),a&&(e.index.hideLoading(),a=!1),e.index.showToast({title:"网络异常，请重试",icon:"none"})}finally{a&&e.index.hideLoading(),this.isLoading=!1}},refreshUserInfo(){let t=!1;try{t=!0,e.index.showLoading({title:"刷新数据..."}),this.getMemberDuration(),setTimeout((()=>{}),1e3)}catch(a){console.error("刷新用户信息失败:",a)}finally{setTimeout((()=>{t&&e.index.hideLoading()}),1e3)}},async getMemberDuration(){try{const e=await i.get("/wx/client/duration/remaining");if(0===e.code&&e.data){const t=e.data.remainingDuration||"0天0小时0分钟",a=t.match(/(\d+)天/)?t.match(/(\d+)天/)[1]:"0",i=t.match(/(\d+)小时/)?t.match(/(\d+)小时/)[1]:"0";this.memberDuration={days:a,hours:i}}else console.error("获取会员时长失败:",null==e?void 0:e.message)}catch(e){console.error("获取会员时长异常:",e)}},handleBack(){e.index.navigateBack()},handleWatch(){this.adInfo.enableWxAd&&this.adInfo.rewardedVideoAdId?this.showRewardedVideoAd():e.index.showToast({title:"广告功能暂未开放",icon:"none"})},goToExchange(){e.index.navigateTo({url:"/pages/vip/exchange/index"})},async getShareImage(){try{const e=await s.getShareSettings();e&&e.default_share_image&&(this.shareImageUrl=e.default_share_image)}catch(e){console.error("获取分享图片失败:",e)}}}};if(!Array){e.resolveComponent("uni-icons")()}Math;const d=e._export_sfc(n,[["render",function(t,a,i,o,s,n){return e.e({a:e.p({type:"left",size:"20",color:"#ffecd8"}),b:e.o(((...e)=>n.handleBack&&n.handleBack(...e))),c:t.statusBarHeight+"px",d:s.userAvatar,e:e.t(s.memberDuration.days),f:e.t(s.memberDuration.hours),g:e.p({type:"right",size:"14",color:"#862c13"}),h:e.p({type:"right",size:"14",color:"#862c13"}),i:e.o(((...e)=>n.goToExchange&&n.goToExchange(...e))),j:e.f(s.platforms,((t,a,i)=>({a:t.icon,b:e.t(t.name),c:a,d:s.currentCategoryId===t.id?1:"",e:e.o((e=>n.selectPlatform(t.id)),a)}))),k:s.packages.length>0},s.packages.length>0?{l:e.f(s.packages,((t,a,i)=>({a:e.t(t.tag),b:e.t(t.name),c:e.t(t.description),d:e.t(t.days),e:a})))}:{},{m:0===s.packages.length},(s.packages.length,{}),{n:e.o(((...e)=>n.handleWatch&&n.handleWatch(...e))),o:e.p({type:"info-filled",size:"20",color:"#ffecd8"}),p:r._imports_1})}]]);n.__runtimeHooks=6,wx.createPage(d);
