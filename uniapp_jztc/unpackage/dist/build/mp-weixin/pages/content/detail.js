"use strict";const e=require("../../common/vendor.js"),t=require("../../mixins/device-adapter.js"),a=require("../../mixins/share.js"),n=require("../../apis/content.js"),o=require("../../utils/date.js"),i=require("../../utils/request.js"),s=require("../../apis/message.js"),r=require("../../utils/share.js"),l={mixins:[t.deviceAdapter,a.shareMixin],components:{ActionBar:()=>"../../components/action-bar/index.js"},data:()=>({contentId:null,contentData:{id:"",title:"",content:"",category:"",publisher:"",publishTime:"",publisher_name:"",publisher_id:"",publisher_avatar:"",images:[],isTop:!1,publish_count:0,comment_count:0,comments:[],cover:""},loading:!1,loadError:!1,errorMsg:"",isFollowed:!1,isCollected:!1,commentLoading:!1,bannerList:[],currentBannerIndex:0,isContentPage:!0}),computed:{pageTitle(){var e;return(null==(e=this.contentData)?void 0:e.title)||"内容详情"},pageStyle(){return{"--nav-height":`${this.layoutSize.navHeight}px`,"--content-padding":`${this.layoutSize.contentPadding}rpx`}}},onLoad(e){e.id?(this.contentId=e.id,this.loadDetail(),this.loadBannerData()):(this.loadError=!0,this.errorMsg="参数错误，缺少内容ID")},onShow(){this.updateShareData()},methods:{filterImgTags:e=>e?e.replace(/<img[^>]*>/g,""):"",formatPublishTime:e=>e?o.formatTimeAgo(e):"",async loadDetail(){if(!this.contentId)return this.loadError=!0,void(this.errorMsg="内容ID无效");this.loading=!0;try{const e=await n.getPublicContentDetail(this.contentId);if(0!==e.code||!e.data)throw new Error(e.message||"获取内容详情失败");{const t=e.data,a=this.filterImgTags(t.content),n=this.formatPublishTime(t.publishTime);this.contentData={id:t.id,title:t.title||"",content:a,category:t.category||"",publishTime:n,publisher:t.publisher||"",publisher_name:t.publisher||"",publisher_id:t.publisher_id||"",publisher_avatar:"",isTop:t.isTop||!1,images:t.images||[],publish_count:0,comment_count:0,comments:[],cover:t.cover||(t.images&&t.images.length>0?t.images[0]:"")},this.loadComments(),this.loadFavoriteStatus(),this.contentData.publisher_id&&this.loadPublisherInfo(),this.recordBrowseHistory(),this.updateShareData()}}catch(e){console.error("加载内容详情失败:",e),this.loadError=!0,this.errorMsg=e.message||"加载失败，请重试"}finally{this.loading=!1}},async loadFavoriteStatus(){try{const e=await n.getFavoriteStatus(this.contentId);0===e.code&&e.data&&(this.isCollected=e.data.isFavorite)}catch(e){console.error("获取收藏状态失败:",e)}},async loadComments(){if(this.contentData.id){this.commentLoading=!0;try{const e=await n.getCommentList(this.contentData.id,{page:1,pageSize:10});0===e.code&&e.data?(this.contentData.comments=(e.data.list||[]).map((e=>({id:e.id,avatar:e.avatarUrl||"",name:e.realName||"匿名用户",content:e.comment||"",time:this.formatPublishTime(e.createdAt)}))),void 0!==e.data.total&&(this.contentData.comment_count=e.data.total)):console.error("获取评论列表失败:",e.message)}catch(e){console.error("加载评论失败:",e)}finally{this.commentLoading=!1}}},handleBack(){e.index.navigateBack()},previewImage(t){e.index.previewImage({current:t,urls:this.contentData.images,success:()=>{console.log("图片预览成功")},fail:e=>{console.error("图片预览失败:",e)}})},async handleFollow(){try{const t=this.contentData.publisher_id;if(!t)return void e.index.showToast({title:"无法获取发布者信息",icon:"none"});let a;if(e.index.showLoading({title:this.isFollowed?"取消关注中...":"关注中...",mask:!0}),a=this.isFollowed?await n.unfollowUser({publisher_id:t}):await n.followUser({publisher_id:t}),e.index.hideLoading(),!a||0!==a.code)throw new Error((null==a?void 0:a.message)||"操作失败");this.isFollowed=!this.isFollowed,e.index.showToast({title:this.isFollowed?"已关注":"已取消关注",icon:"success"})}catch(t){e.index.hideLoading(),console.error("关注操作失败:",t),e.index.showToast({title:t.message||"操作失败，请重试",icon:"none"})}},handleComment(){e.index.showModal({title:"留言",editable:!0,placeholderText:"请输入留言内容",success:async t=>{if(t.confirm&&t.content){let o=!1;try{const a={comment:t.content,contentId:this.contentId};e.index.showLoading({title:"提交中..."}),o=!0;const i=await n.createComment(a);if(e.index.hideLoading(),o=!1,0!==i.code)throw new Error(i.message||"评论失败");e.index.showToast({title:"留言成功",icon:"success"}),this.loadComments()}catch(a){o&&(e.index.hideLoading(),o=!1),console.error("提交评论失败:",a),e.index.showToast({title:a.message||"留言失败，请重试",icon:"none"})}finally{o&&e.index.hideLoading()}}}})},handleShare(){this.updateShareData(),e.index.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]})},async handleMessage(){const t=this.contentData.publisher_id||"";if(t)try{const a=await s.createConversation({targetId:parseInt(t)});if(!a||0!==a.code)throw new Error((null==a?void 0:a.message)||"创建会话失败");e.index.navigateTo({url:`/pages/chat/detail?id=${t}&nickName=${encodeURIComponent(this.contentData.publisher_name||"用户")}`,fail:t=>{console.error("跳转到聊天页面失败:",t),e.index.showToast({title:"无法打开聊天页面",icon:"none"})}})}catch(a){console.error("私信功能错误:",a),e.index.showToast({title:"无法发起私信，请重试",icon:"none"})}else e.index.showToast({title:"无法获取发布者信息",icon:"none"})},async handleCollect(){try{let t;if(e.index.showLoading({title:this.isCollected?"取消收藏中...":"收藏中...",mask:!0}),t=this.isCollected?await n.cancelFavorite(this.contentId):await n.addFavorite(this.contentId),e.index.hideLoading(),0!==t.code)throw new Error(t.message||"操作失败");this.isCollected=!this.isCollected,e.index.showToast({title:this.isCollected?"已收藏":"已取消收藏",icon:"success"})}catch(t){e.index.hideLoading(),console.error("收藏操作失败:",t),e.index.showToast({title:t.message||"操作失败，请重试",icon:"none"})}},handleBannerClick(t){if(t&&t.linkUrl)if("page"===t.linkType)e.index.navigateTo({url:"/"+t.linkUrl,fail:e=>{console.error("页面跳转失败",t.linkUrl,e)}});else if("webview"===t.linkType){if(!this.isValidUrl(t.linkUrl))return void e.index.showToast({title:"无效的URL",icon:"none"});void 0!==e.wx$1&&e.wx$1.setWebViewSecurity?e.wx$1.setWebViewSecurity({enable:!0,success:()=>{console.log("成功设置WebView安全模式"),this.navigateToWebView(t.linkUrl)},fail:e=>{console.error("设置WebView安全模式失败:",e),this.navigateToWebView(t.linkUrl)}}):this.navigateToWebView(t.linkUrl)}else"miniprogram"===t.linkType&&e.index.navigateToMiniProgram({appId:t.linkUrl,fail:a=>{console.error("小程序跳转失败",t.linkUrl,a),e.index.showToast({title:"跳转失败",icon:"none"})}})},isValidUrl(e){if(!e)return!1;try{return new URL(e),!0}catch(t){return!1}},navigateToWebView(t){const a=`${t.includes("?")?"&":"?"}coop=cross-origin&coep=require-corp`;let n=t;(t.startsWith("http://")||t.startsWith("https://"))&&(n=t+a),e.index.navigateTo({url:"/pages/webview/index?url="+encodeURIComponent(n),fail:a=>{console.error("网页跳转失败",t,a),e.index.showToast({title:"网页打开失败",icon:"none"})}})},async recordBrowseHistory(){try{const e=this.contentData.id||this.contentId;if(!e)return void console.error("记录浏览历史失败: 缺少有效的内容ID");await n.addBrowseRecord(e,"article")}catch(e){console.error("记录浏览历史失败:",e)}},async loadPublisherInfo(){try{const e=this.contentData.publisher_id;if(!e)return void console.error("无法加载发布者信息: publisher_id不存在");const t=String(e),a=await n.getPublisherInfo(t);if(a&&0===a.code&&a.data){const e=a.data;e.real_name&&(this.contentData.publisher_name=e.real_name),e.avatar_url&&(this.contentData.publisher_avatar=e.avatar_url),void 0!==e.publish_count&&(this.contentData.publish_count=e.publish_count),await this.loadFollowStatus(t)}else console.error("获取发布者信息失败:",(null==a?void 0:a.message)||"未知错误")}catch(e){console.error("加载发布者信息异常:",e)}},async loadFollowStatus(e){try{if(!e)return void console.error("无法获取关注状态: publisher_id不存在");const t=await n.getPublisherFollowStatus(e);t&&0===t.code&&t.data?this.isFollowed=!!t.data.is_followed:console.error("获取关注状态失败:",(null==t?void 0:t.message)||"未知错误")}catch(t){console.error("加载关注状态异常:",t)}},async loadBannerData(){try{const e=await i.get("/wx/inner-banner/list",{bannerType:"home"});e&&0===e.code&&e.data&&e.data.isGlobalEnabled&&e.data.list&&e.data.list.length>0&&(this.bannerList=e.data.list.filter((e=>e.isEnabled)).sort(((e,t)=>e.order-t.order)))}catch(e){console.error("获取轮播图数据失败",e)}},handleSwiperChange(e){this.currentBannerIndex=e.detail.current},async updateShareData(){try{const e=await r.getShareSettings();if(e&&this.contentData){const t=this.contentData.title||e.content_share_text||"查看内容详情";let a="";this.contentData.cover?a=this.contentData.cover:this.contentData.images&&this.contentData.images.length>0?a=this.contentData.images[0]:e.content_share_image&&(a=e.content_share_image),this.shareData={title:t,imageUrl:a,path:`/pages/content/detail?id=${this.contentId}`},console.log("内容分享数据已更新:",this.shareData)}else this.initShareData()}catch(e){console.error("更新分享数据失败:",e),this.initShareData()}}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("action-bar"))()}Math;const c=e._export_sfc(l,[["render",function(t,a,n,o,i,s){return e.e({a:e.p({type:"left",size:"20",color:"#333333"}),b:e.o(((...e)=>s.handleBack&&s.handleBack(...e))),c:e.t(s.pageTitle),d:t.statusBarHeight+"px",e:i.loading},(i.loading,{}),{f:i.loadError},i.loadError?{g:e.t(i.errorMsg),h:e.o(((...e)=>s.loadDetail&&s.loadDetail(...e)))}:{},{i:!i.loading&&!i.loadError},i.loading||i.loadError?{}:e.e({j:i.contentData.isTop},(i.contentData.isTop,{}),{k:e.t(i.contentData.category),l:e.t(i.contentData.title),m:e.t(i.contentData.publisher),n:e.t(i.contentData.publishTime),o:i.contentData.content},i.contentData.content?{p:i.contentData.content}:{},{q:i.contentData.images&&i.contentData.images.length},i.contentData.images&&i.contentData.images.length?{r:e.f(i.contentData.images,((t,a,n)=>({a:a,b:t,c:e.o((e=>s.previewImage(a)),a)})))}:{},{s:i.contentData.publisher_avatar,t:e.t(i.contentData.publisher_name),v:e.t(i.contentData.publish_count),w:e.t(i.isFollowed?"已关注":"关注"),x:e.o(((...e)=>s.handleFollow&&s.handleFollow(...e))),y:i.bannerList.length>0},i.bannerList.length>0?e.e({z:e.f(i.bannerList,((t,a,n)=>({a:t.image,b:a,c:e.o((e=>s.handleBannerClick(t)),a)}))),A:e.o(((...e)=>s.handleSwiperChange&&s.handleSwiperChange(...e))),B:i.bannerList.length>1},i.bannerList.length>1?{C:e.f(i.bannerList,((e,t,a)=>({a:t,b:i.currentBannerIndex===t?1:""})))}:{}):{},{D:e.t(i.contentData.comment_count),E:e.p({type:"chat",size:"14",color:"#007AFF"}),F:e.o(((...e)=>s.handleComment&&s.handleComment(...e))),G:i.contentData.comments&&i.contentData.comments.length},i.contentData.comments&&i.contentData.comments.length?{H:e.f(i.contentData.comments,((t,a,n)=>({a:t.avatar,b:e.t(t.name),c:e.t(t.content),d:e.t(t.time),e:a})))}:{}),{I:t.navigationBarHeight+"px",J:e.o(s.handleComment),K:e.o(s.handleCollect),L:e.o(s.handleShare),M:e.o(s.handleMessage),N:e.p({"is-collected":i.isCollected,publisher:{id:i.contentData.publisher_id,name:i.contentData.publisher_name}}),O:e.s(s.pageStyle)})}]]);wx.createPage(c);
