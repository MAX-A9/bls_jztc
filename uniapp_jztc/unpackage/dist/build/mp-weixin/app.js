"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./common/vendor.js"),t=require("./utils/auth.js"),o=require("./utils/navigation-control.js"),n=require("./utils/uni-compatibility.js"),r=require("./store/index.js");Math;let i=!1;const s={onLaunch:function(){i||(n.initUniCompatibility(),this.initRequestInterceptor(),this.initNavigationInterceptor(),i=!0),setTimeout((()=>{const e=setTimeout((()=>{console.log("自动登录超时，继续应用初始化")}),3e3);this.autoLogin().finally((()=>{clearTimeout(e)}))}),100),this.disableSharedArrayBuffer()},onShow:function(){setTimeout((()=>{const t=this.$store;t&&t.dispatch&&(console.log("App显示时开始加载区域列表数据..."),t.dispatch("region/getRegionList").then((t=>{if(t&&t.length>0){const o=e.index.getStorageSync("currentLocationId");if(o)console.log("App显示时发送位置更新事件，使用已有位置ID:",o),e.index.$emit("locationChanged",{regionId:o});else{const o=t[0];e.index.setStorageSync("currentLocationId",o.id),e.index.setStorageSync("currentLocation",o.name),console.log("App显示时更新位置信息:",o.name,o.id),e.index.$emit("locationChanged",{regionId:o.id})}}})).catch((e=>{console.error("初始化区域列表失败:",e)})))}),200)},onHide:function(){},methods:{async autoLogin(){try{if(this.$store.getters["user/token"]){const t=this.$store.getters["user/userInfo"],o=t&&(t.clientId||t.id),n=t&&t.realName;if(!o||!n)try{await this.$store.dispatch("user/getUserInfo")}catch(e){await this.$store.dispatch("user/silentLogin")}}else{const e=await t.checkAndAutoLogin();e&&(e.token&&this.$store.commit("user/SET_TOKEN",e.token),this.$store.commit("user/SET_USER_INFO",e.userInfo||e))}}catch(o){console.log("自动登录失败:",o)}return Promise.resolve()},initRequestInterceptor(){e.index.addInterceptor("request",{fail:e=>e}),e.index.addInterceptor("response",{response(t){if(401===t.statusCode){e.index.showToast({title:"登录已过期，请重新登录",icon:"none"});const t=getApp().$vm.$store;t&&t.dispatch("user/logout")}return t}})},initNavigationInterceptor(){o.navigationControl.initNavigationInterceptors(),e.index.addInterceptor("navigateBack",{invoke(e){const t=getCurrentPages();if(t.length<2)return e;const n=t[t.length-1],r=t[t.length-2],i=`/${n.route}`,s=`/${r.route}`;return o.navigationControl.beforeNavigateBack(i,s),e}})},disableSharedArrayBuffer(){e.index.addInterceptor("request",{invoke:e=>(e.header||(e.header={}),e.header["Cross-Origin-Opener-Policy"]="same-origin",e.header["Cross-Origin-Embedder-Policy"]="require-corp",e)}),void 0!==e.wx$1&&e.wx$1.onWebViewLoad&&e.wx$1.onWebViewLoad((function(){try{"undefined"!=typeof SharedArrayBuffer&&console.warn("已禁用SharedArrayBuffer以提高安全性")}catch(e){}}))}}};function a(){const t=e.createSSRApp(s);return t.use(r.store),t.config.errorHandler=function(e,t,o){console.error("Vue错误:",e),console.error("错误信息:",o)},{app:t}}a().app.mount("#app"),exports.createApp=a;
